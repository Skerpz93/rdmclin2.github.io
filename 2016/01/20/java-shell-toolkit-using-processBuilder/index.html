<!DOCTYPE html><html lang="zh-Hans"><head><meta charset="utf-8"><meta name="X-UA-Compatible" content="IE=edge"><title> Java使用ProcessBuilder类编写shell工具类 · Mcl's space</title><meta name="description" content="Java使用ProcessBuilder类编写shell工具类 - LinChen"><meta name="viewport" content="width=device-width, initial-scale=1"><link rel="short icon" href="/favicon.ico"><link rel="stylesheet" href="/css/apollo.css"><link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Source+Sans+Pro:400,600" type="text/css"></head><body><header><a href="/" class="logo-link"><img src="/favicon.png"></a><ul class="nav nav-list"><li class="nav-list-item"><a href="/" target="_self" class="nav-list-link">BLOG</a></li><li class="nav-list-item"><a href="/archives/" target="_self" class="nav-list-link">ARCHIVE</a></li><li class="nav-list-item"><a href="http://weibo.com/rdmclin2" target="_blank" class="nav-list-link">WEIBO</a></li><li class="nav-list-item"><a href="https://github.com/rdmclin2" target="_blank" class="nav-list-link">GITHUB</a></li><li class="nav-list-item"><a href="/atom.xml" target="_self" class="nav-list-link">RSS</a></li></ul></header><section class="container"><div class="post"><article class="post-block"><h1 class="post-title">Java使用ProcessBuilder类编写shell工具类</h1><div class="post-time">Jan 20, 2016</div><div class="post-content"><h1 id="前言">前言</h1><p>最近使用Java编写用于测试平台的工具类，有个需求是在java中调用命令行语句并获取输出，在Java中有两种方式可以完成这个任务。一个是<code>Runtime.getRuntime().exec()</code>（java1.5之前），java1.5之后提供了<a href="https://docs.oracle.com/javase/7/docs/api/java/lang/ProcessBuilder.html" target="_blank" rel="external">ProcessBuilder</a>类来构建进程。由于Runtime的方法不够灵活，而且我们项目不需要兼容老版本java，这里用ProcessBuilder来构建这个工具类。</p>
<a id="more"></a>
<p>PS: 代码中写了一些方便的adb和adbshell方法，完全可以定制自己的快捷方法。为防止线程阻塞,我们用了另一个线程读取线程的输出流。</p>
<h1 id="代码">代码</h1><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">package com.nata;&#10;&#10;import java.io.IOException;&#10;import java.io.InputStream;&#10;import java.io.InputStreamReader;&#10;import java.util.ArrayList;&#10;import java.util.List;&#10;import java.util.Scanner;&#10;&#10;/**&#10; * Author: Calvin Meng&#10; * Blog: mclspace.com  Email: rdmclin2@gamil.com&#10; * Update: 2016-01-20 14:23&#10; */&#10;public class ShellKit &#123;&#10;    /**&#10;     * Run shell command starting with &#39;adb&#39;&#10;     *&#10;     * @param cmd command list to execute&#10;     * @return  Any Output&#10;     */&#10;    public static String adb(List&#60;String&#62; cmd) &#123;&#10;        cmd.add(0, &#34;adb&#34;);&#10;        return command(cmd);&#10;    &#125;&#10;&#10;    /**&#10;     * Run shell command starting with &#39;adb&#39;&#10;     *&#10;     * @param cmd command to execute ,tokenize with whitespace&#10;     * @return  Any Output&#10;     */&#10;    public static String adb(String cmd) &#123;&#10;        String[] splits = cmd.split(&#34; &#34;);&#10;        return adb(splits);&#10;    &#125;&#10;&#10;    /**&#10;     * Run shell command starting with &#39;adb&#39;&#10;     *&#10;     * @param cmd command string array to execute&#10;     * @return  Any Output&#10;     */&#10;    public static String adb(String... cmd) &#123;&#10;        ArrayList&#60;String&#62; cmds = new ArrayList&#60;&#62;();&#10;        cmds.add(&#34;adb&#34;);&#10;        for (String part:cmd&#10;                ) &#123;&#10;            cmds.add(part) ;&#10;        &#125;&#10;        return command(cmds);&#10;    &#125;&#10;&#10;    /**&#10;     * Run shell command starting with &#39;adb shell&#39;&#10;     *&#10;     * @param cmd command list to execute&#10;     * @return running Any Output&#10;     */&#10;    public static String adbShell(List&#60;String&#62; cmd) &#123;&#10;        cmd.add(0, &#34;shell&#34;);&#10;        cmd.add(0, &#34;adb&#34;);&#10;        return command(cmd);&#10;    &#125;&#10;&#10;    /**&#10;     * Run shell command starting with &#39;adb shell&#39;&#10;     *&#10;     * @param cmd command to execute ,tokenize with whitespace&#10;     * @return  Any Output&#10;     */&#10;&#10;    public static String adbShell(String cmd) &#123;&#10;        String[] splits = cmd.split(&#34; &#34;);&#10;        return adbShell(splits);&#10;    &#125;&#10;&#10;    /**&#10;     * Run shell command starting with &#39;adb shell&#39;&#10;     *&#10;     * @param cmd command string array to execute&#10;     * @return  Any Output&#10;     */&#10;    public static String adbShell(String... cmd) &#123;&#10;        ArrayList&#60;String&#62; cmds = new ArrayList&#60;&#62;();&#10;        cmds.add(&#34;adb&#34;);&#10;        cmds.add(&#34;shell&#34;);&#10;        for (String part:cmd&#10;                ) &#123;&#10;            cmds.add(part) ;&#10;        &#125;&#10;        return command(cmds);&#10;    &#125;&#10;&#10;    /**&#10;     * Execute a shell command and return its output&#10;     *&#10;     * @param command command to execute&#10;     * @return process executed&#10;     */&#10;    public static String command(List&#60;String&#62; command) &#123;&#10;        //set redirectErrorStream to be true to cross output streams&#10;        ProcessBuilder pb = new ProcessBuilder(command).redirectErrorStream(true);&#10;        String output = &#34;&#34;;&#10;&#10;        try &#123;&#10;            Process process = pb.start();&#10;&#10;            IOThreadHandler outputHandler = new IOThreadHandler(&#10;                    process.getInputStream());&#10;&#10;            outputHandler.start();&#10;&#10;            //wait for the process to stop&#10;            process.waitFor();&#10;&#10;            //in case the process stopped before the thread&#10;            outputHandler.join();&#10;&#10;            output = outputHandler.getOutput();&#10;&#10;        &#125; catch (InterruptedException | IOException e) &#123;&#10;            e.printStackTrace();&#10;        &#125;&#10;        return output;&#10;&#10;    &#125;&#10;&#10;    /**&#10;     * Thread to drain the output of cmd running&#10;     */&#10;    private static class IOThreadHandler extends Thread &#123;&#10;        private InputStream inputStream;&#10;        private StringBuilder output = new StringBuilder();&#10;&#10;        IOThreadHandler(InputStream inputStream) &#123;&#10;            this.inputStream = inputStream;&#10;        &#125;&#10;&#10;        public void run() &#123;&#10;            try (Scanner br = new Scanner(new InputStreamReader(inputStream))) &#123;&#10;                String line = null;&#10;                while (br.hasNextLine()) &#123;&#10;                    line = br.nextLine();&#10;                    output.append(line).append(System.getProperty(&#34;line.separator&#34;));&#10;                &#125;&#10;            &#125;&#10;        &#125;&#10;&#10;        public String getOutput() &#123;&#10;            return output.toString();&#10;        &#125;&#10;    &#125;&#10;&#10;&#10;    //mininal unit test&#10;    public static void main(String[] args) &#123;&#10;        ArrayList&#60;String&#62; cmds = new ArrayList&#60;&#62;();&#10;        cmds.add(&#34;devices&#34;);&#10;        System.out.println(ShellKit.adb(cmds));&#10;&#10;        cmds.clear();&#10;        cmds.add(&#34;getprop&#34;);&#10;        cmds.add(&#34;ro.boot.serialno&#34;);&#10;&#10;        System.out.println(ShellKit.adbShell(cmds));&#10;    &#125;&#10;&#125;</span><br></pre></td></tr></table></figure>
<h1 id="参考资料">参考资料</h1><p><a href="http://www.javaworld.com/article/2071275/core-java/when-runtime-exec---won-t.html?page=3" target="_blank" rel="external">When Runtime.exec() won’t</a></p>
<blockquote>
<p>这篇文章很不错,建议一看，只是发布时间有点晚了。</p>
</blockquote>
<p><a href="http://stackoverflow.com/questions/6856028/difference-between-processbuilder-and-runtime-exec" target="_blank" rel="external">runtime.exec 和 processbuilder的区别</a></p>
</div></article></div></section><footer><div class="paginator"><a href="/2016/01/24/nodejs-tutorials-2/" class="prev">PRVE</a><a href="/2016/01/18/nodejs-tutorials-1/" class="next">NEXT</a></div><div id="disqus_thread"></div><script>var disqus_shortname = 'mcl';
var disqus_identifier = '2016/01/20/java-shell-toolkit-using-processBuilder/';
var disqus_title = 'Java使用ProcessBuilder类编写shell工具类';
var disqus_url = 'http://www.mclspace.com/2016/01/20/java-shell-toolkit-using-processBuilder/';
(function() {
    var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
    dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
    (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
})();</script><script id="dsq-count-scr" src="//mcl.disqus.com/count.js" async></script><div class="copyright"><p>© 2015 - 2016 <a href="http://www.mclspace.com">LinChen</a>, unless otherwise noted.</p></div></footer><script>var _hmt = _hmt || [];(function() {var hm = document.createElement("script");hm.src = "//hm.baidu.com/hm.js?6b26d13232555e4d64b5a8c3567ccda9";var s = document.getElementsByTagName("script")[0]; s.parentNode.insertBefore(hm, s);})();</script><script src="https://cdn.bootcss.com/mathjax/2.5.3/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script></body></html>