<!DOCTYPE html><html lang="zh-Hans"><head><meta charset="utf-8"><meta name="X-UA-Compatible" content="IE=edge"><title> EMMA教程 · Mcl's space</title><meta name="description" content="EMMA教程 - LinChen"><meta name="viewport" content="width=device-width, initial-scale=1"><link rel="short icon" href="/favicon.ico"><link rel="stylesheet" href="/css/apollo.css"><link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Source+Sans+Pro:400,600" type="text/css"></head><body><header><a href="/" class="logo-link"><img src="/favicon.png"></a><ul class="nav nav-list"><li class="nav-list-item"><a href="/" target="_self" class="nav-list-link">BLOG</a></li><li class="nav-list-item"><a href="/archives/" target="_self" class="nav-list-link">ARCHIVE</a></li><li class="nav-list-item"><a href="http://weibo.com/rdmclin2" target="_blank" class="nav-list-link">WEIBO</a></li><li class="nav-list-item"><a href="https://github.com/rdmclin2" target="_blank" class="nav-list-link">GITHUB</a></li><li class="nav-list-item"><a href="/atom.xml" target="_self" class="nav-list-link">RSS</a></li></ul></header><section class="container"><div class="post"><article class="post-block"><h1 class="post-title">EMMA教程</h1><div class="post-time">Dec 25, 2014</div><div class="post-content"><h2 id="什么是Emma？">什么是Emma？</h2><blockquote>
<p>EMMA 是一个用于检测和报告 JAVA 代码覆盖率的开源工具。它不但能很好的用于小型项目，很方便得得出覆盖率报告，而且适用于大型企业级别的项目。</p>
</blockquote>
<p>本篇教程写给不愿意看emma userguide文档的兔子们，主要目标是给没有接触过emma的人一个可以成功运行的实例，傻瓜式教程。</p>
<a id="more"></a>
<hr>
<h2 id="准备工作">准备工作</h2><ul>
<li>下载emma文件 【<a href="http://sourceforge.net/projects/emma/files/?source=navbar" target="_blank" rel="external">下载地址</a>】</li>
<li>解压下载下来的文件 将lib/文件夹下的emma.jar放到你电脑的jre文件夹的/lib/ext/文件夹下，也可能是jdk文件夹的jre/lib/ext文件夹下，取决于你的电脑使用的是jre还是jdk。也可以每次运行的时候把emma.jar的路径加到命令中，不过太繁琐了。</li>
</ul>
<hr>
<h2 id="Emma_on-the-fly模式">Emma on-the-fly模式</h2><p>Emma 有两种运行模式，一种是on-the-fly模式，一种是offline模式。</p>
<blockquote>
<p>On the fly 模式往加载的类中加入字节码，相当于用 EMMA 实现的 application class loader 替代原来的 application class loader。<br>Offline 模式在类被加载前，加入字节码</p>
</blockquote>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#60;!-- &#39318;&#20808;&#29992;&#32456;&#31471;cd&#21040;&#19979;&#36733;&#19979;&#26469;&#30340;emma&#25991;&#20214;&#22841;&#30340;examples&#25991;&#20214;&#30446;&#24405; --&#62;&#10;$ mkdir out&#10;$ javac -d out -g src/*.java src/search/*.java src/search/*.java&#10;$ java -cp out Main&#10;main(): running doSearch()...&#10;main(): done&#10;&#60;!-- &#23558;emmarun&#21629;&#20196;&#25918;&#22312; main&#31867;&#20043;&#21069; --&#62;&#10;$java emmarun -cp out Main</span><br></pre></td></tr></table></figure>
<p>用户手册上的这个命令会报错，emma有好几年没有更新了，因此当java7出来后有一些新的特性，emma没有能够及时支持,使用下面的命令可以成功运行，具体可以看【<a href="https://stackoverflow.com/questions/19437050/using-emmarun-main-method-not-found" target="_blank" rel="external">StackOverflow上的解释</a>】,下文中也有些命令需要这个参数<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ java -XX:-UseSplitVerifier emmarun -cp out Main</span><br></pre></td></tr></table></figure></p>
<p>完成上一步后应该可以看到如下结果：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[EMMA v2.0.5312 report, generated Thu Dec 25 21:40:41 CST 2014]&#10;-------------------------------------------------------------------------------&#10;OVERALL COVERAGE SUMMARY:&#10;&#10;[class, %]&#9;[method, %]&#9;[block, %]&#9;[line, %]&#9;[name]&#10;100% (3/3)&#9;100% (7/7)&#9;95%  (120/126)&#9;90%  (27/30)&#9;all classes&#10;&#10;OVERALL STATS SUMMARY:&#10;&#10;total packages:&#9;2&#10;total classes:&#9;3&#10;total methods:&#9;7&#10;total executable files:&#9;3&#10;total executable lines:&#9;30&#10;&#10;COVERAGE BREAKDOWN BY PACKAGE:&#10;&#10;[class, %]&#9;[method, %]&#9;[block, %]&#9;[line, %]&#9;[name]&#10;100% (2/2)&#9;100% (4/4)&#9;91%  (64/70)&#9;84%  (16/19)&#9;search&#10;100% (1/1)&#9;100% (3/3)&#9;100% (56/56)&#9;100% (11/11)&#9;default package&#10;-------------------------------------------------------------------------------</span><br></pre></td></tr></table></figure></p>
<hr>
<h2 id="Emma_offline模式">Emma offline模式</h2><p>在offline模式下，emma的功能分成了几个子命令：<strong>instr</strong>,<strong>merge</strong>和<strong>report</strong></p>
<h3 id="1-插装">1.插装</h3><p>instrument在测试中是插装的意思。</p>
<blockquote>
<p>当你运行一段代码时，你如何判断哪些语句、条件、分支、路径执行过了？如果这个都不能判断，那覆盖率无从谈起。<br>代码插装就是在要测的代码中插入你写的一些代码，可以是（但不限于）打印语句等。知道了代码中哪些部分已经执行过了，那我们就可以有的放矢，针对没有覆盖到的语句、条件、分支、条件分支、路径等补充用例以达到更充分的覆盖。<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#60;!-- &#21644;&#19978;&#38754;&#19968;&#26679;&#65292;&#29992;&#32456;&#31471;cd&#21040;&#19979;&#36733;&#19979;&#26469;&#30340;emma&#25991;&#20214;&#22841;&#30340;examples&#25991;&#20214;&#30446;&#24405; &#20026;&#20102;&#20445;&#38505;&#36215;&#35265;&#10;&#9;&#65292;&#23558;&#25554;&#35013;&#21518;&#29983;&#25104;&#30340;.class&#25991;&#20214;&#25918;&#22312;&#21478;&#19968;&#20010;&#25991;&#20214;&#20013;--&#62;&#10;$ mkdir out&#10;$ javac -d out -g src/*.java src/search/*.java src/search/*.java&#10;$ mkdir outinstr&#10;$ java emma instr -d outinstr -ip out&#10;EMMA: processing instrumentation path ...&#10;EMMA: instrumentation path processed in 116 ms&#10;EMMA: [3 class(es) instrumented, 0 resource(s) copied]&#10;EMMA: metadata merged into [...coverage.em] &#123;in 31 ms&#125;</span><br></pre></td></tr></table></figure></p>
</blockquote>
<p>此步骤完成后，会生成coverage.em文件，教程中讲是dump出来的类的元数据(metadata)。</p>
<h3 id="2-执行">2.执行</h3><p>运行插装后的程序<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ java -XX:-UseSplitVerifier -cp outinstr;out Main&#10;EMMA: collecting runtime coverage data ...&#10;main(): running doSearch()...&#10;main(): done&#10;EMMA: runtime coverage data merged into [...coverage.ec] &#123;in 32 ms&#125;</span><br></pre></td></tr></table></figure></p>
<p>此步骤完成后，会生成coverage.ec文件，当JVM退出时，EMMA将运行时覆盖轮廓(runtime coverage profile),写进该文件中。<br>注意此命令中的classpath：outinstr;out，插装的类必须放在第一个，因为instr命令时没有复制无法执行的东西，如接口和资源，因此原始的out文件夹应该放在outinstr文件夹后。</p>
<h3 id="3-生成报告">3.生成报告</h3><p>此步骤将类的原数据和运行时的覆盖轮廓结合起来生成一个txt形式的报告和一个html形式的报告。<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ java emma report -r txt,html -in coverage.em -in coverage.ec&#10;EMMA: 2 file(s) read and merged in 43 ms&#10;EMMA: writing [txt] report to [...coverage.txt] ...&#10;EMMA: writing [html] report to [...coverage/index.html] ...</span><br></pre></td></tr></table></figure></p>
<h3 id="可选操作：合并">可选操作：合并</h3><p>可以将生成的文件合并成一个。<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ java emma merge -in coverage.em -in coverage.ec -out coverage.es&#10;EMMA: processing input files ...&#10;EMMA: 2 file(s) read and merged in 42 ms&#10;EMMA: merged/compacted data written to [...coverage.es] &#123;in 58 ms&#125;</span><br></pre></td></tr></table></figure></p>
<h3 id="运行结果">运行结果</h3><p>运行完以上命令后可以查看生成的html覆盖率结果分析如下：<br><img src="http://icoco.qiniudn.com/image/test/report.PNG" alt="覆盖率html报告"></p>
<hr>
<h1 id="参考文献">参考文献</h1><ul>
<li><a href="http://emma.sourceforge.net/" target="_blank" rel="external">EMMA官网</a></li>
<li><a href="http://www.ibm.com/developerworks/cn/java/j-lo-emma/#download" target="_blank" rel="external">使用 EMMA 测量测试覆盖率</a></li>
<li><a href="http://www.ibm.com/developerworks/cn/opensource/os-cn-emma/#download" target="_blank" rel="external">使用 EMMA 获得功能测试覆盖率</a></li>
<li><a href="http://tech.meituan.com/emma.html" target="_blank" rel="external">Emma使用与分析</a></li>
</ul>
<hr>
</div></article></div></section><footer><div class="paginator"><a href="/2014/12/26/markdown-here/" class="prev">PRVE</a><a href="/2014/12/18/EvoDroid/" class="next">NEXT</a></div><div id="disqus_thread"></div><script>var disqus_shortname = 'mcl';
var disqus_identifier = '2014/12/25/emma-tutorial/';
var disqus_title = 'EMMA教程';
var disqus_url = 'http://www.mclspace.com/2014/12/25/emma-tutorial/';
(function() {
    var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
    dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
    (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
})();</script><script id="dsq-count-scr" src="//mcl.disqus.com/count.js" async></script><div class="copyright"><p>© 2015 - 2016 <a href="http://www.mclspace.com">LinChen</a>, unless otherwise noted.</p></div></footer><script>var _hmt = _hmt || [];(function() {var hm = document.createElement("script");hm.src = "//hm.baidu.com/hm.js?6b26d13232555e4d64b5a8c3567ccda9";var s = document.getElementsByTagName("script")[0]; s.parentNode.insertBefore(hm, s);})();</script><script src="https://cdn.bootcss.com/mathjax/2.5.3/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script></body></html>