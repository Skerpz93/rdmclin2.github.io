<!DOCTYPE html><html lang="zh-CN"><head><meta charset="utf-8"><meta name="X-UA-Compatible" content="IE=edge"><title> 创建Dockerfile · 兼续</title><meta name="description" content="创建Dockerfile - LinChen"><meta name="viewport" content="width=device-width, initial-scale=1"><link rel="short icon" href="/favicon.ico"><link rel="stylesheet" href="/css/apollo.css"><link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Source+Sans+Pro:400,600" type="text/css"></head><body><header><a href="/" class="logo-link"><img src="/favicon.png"></a><ul class="nav nav-list"><li class="nav-list-item"><a href="/" target="_self" class="nav-list-link">BLOG</a></li><li class="nav-list-item"><a href="/archives/" target="_self" class="nav-list-link">ARCHIVE</a></li><li class="nav-list-item"><a href="http://weibo.com/rdmclin2" target="_blank" class="nav-list-link">WEIBO</a></li><li class="nav-list-item"><a href="https://github.com/rdmclin2" target="_blank" class="nav-list-link">GITHUB</a></li><li class="nav-list-item"><a href="/atom.xml" target="_self" class="nav-list-link">RSS</a></li><li class="nav-list-item"><a href="http://www.jianshu.com/users/34733105f724/latest_articles" target="_blank" class="nav-list-link">JIANSHU</a></li></ul></header><section class="container"><div class="post"><article class="post-block"><h1 class="post-title">创建Dockerfile</h1><div class="post-time">2015年9月16日</div><div class="post-content"><blockquote>
<p>本篇收集整理关于创建Dockerfile的相关知识</p>
</blockquote>
<a id="more"></a>
<h2 id="Dockerfile命令"><a href="#Dockerfile命令" class="headerlink" title="Dockerfile命令"></a>Dockerfile命令</h2><h3 id="FROM"><a href="#FROM" class="headerlink" title="FROM"></a>FROM</h3><p>设置基础镜像<br><code>FROM ubuntu:14.10</code></p>
<h3 id="MAINTAINER"><a href="#MAINTAINER" class="headerlink" title="MAINTAINER"></a>MAINTAINER</h3><p>设置维护者信息<br><code>MAINTAINER rdmclin2 &quot;rdmclin2@gmail.com&quot;</code></p>
<h3 id="ENV"><a href="#ENV" class="headerlink" title="ENV"></a>ENV</h3><p>指定环境变量<br><code>ENV NODE_VERSION 1.20.1</code></p>
<h3 id="WORKDIR"><a href="#WORKDIR" class="headerlink" title="WORKDIR"></a>WORKDIR</h3><p>设置工作目录<br><code>WORKDIR /srv/hello</code></p>
<h3 id="RUN"><a href="#RUN" class="headerlink" title="RUN"></a>RUN</h3><p>运行命令<br><code>RUN apt-get update</code></p>
<h3 id="ADD-COPY"><a href="#ADD-COPY" class="headerlink" title="ADD COPY"></a>ADD COPY</h3><p>将Dockerfile所在目录中的文件添加至镜像的目录中<br><code>ADD . /srv/hello</code></p>
<p>和COPY相比ADD 多了2个功能, 下载URL和解压.  其他都一样.<br>如果你不希望压缩文件拷贝到container后会被解压的话, 那么使用COPY.<br>如果需要自动下载URL并拷贝到container的话, 请使用ADD.</p>
<h3 id="EXPOSE"><a href="#EXPOSE" class="headerlink" title="EXPOSE"></a>EXPOSE</h3><p>暴露端口<br><code>EXPOSE 3001</code></p>
<h3 id="CMD"><a href="#CMD" class="headerlink" title="CMD"></a>CMD</h3><p>设置启动时默认运行命令<br><code>CMD [&quot;nodejs”, “/srv/hello/index&quot;]</code></p>
<h3 id="VOLUME"><a href="#VOLUME" class="headerlink" title="VOLUME"></a>VOLUME</h3><p>VOLUME指令用于在容器内创建一个或多个卷<br><code>VOLUME [&quot;路径&quot;]</code></p>
<h3 id="USER"><a href="#USER" class="headerlink" title="USER"></a>USER</h3><p>USER指令用于容器内运行RUN指令或CMD指令的用户。例如，在构建一个nginx镜像时，你希望最后运行nginx的用户为nginx，就可以在CMD [“nginx”]之前将用户设置为nginx。<br>如果在运行docker run命令时设置了-u 用户名参数，那么将覆盖USER指令设置的用户。</p>
<h3 id="ONBUILD"><a href="#ONBUILD" class="headerlink" title="ONBUILD"></a>ONBUILD</h3><p>ONBUILD指令用于设置一些指令，当本镜像作为基础镜像被其他Dockerfile用FROM指令引用时，在所有其他指令执行之前先执行这些指令。</p>
<p>##技巧</p>
<h3 id="用bash替换默认的sh，避免不支持source等指令"><a href="#用bash替换默认的sh，避免不支持source等指令" class="headerlink" title="用bash替换默认的sh，避免不支持source等指令"></a>用bash替换默认的sh，避免不支持source等指令</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">RUN rm /bin/sh &amp;&amp; ln -s /bin/bash /bin/sh</div></pre></td></tr></table></figure>
<h2 id="示例Dockerfile-boot2docker"><a href="#示例Dockerfile-boot2docker" class="headerlink" title="示例Dockerfile ,boot2docker"></a>示例Dockerfile ,boot2docker</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div><div class="line">99</div><div class="line">100</div><div class="line">101</div><div class="line">102</div><div class="line">103</div><div class="line">104</div><div class="line">105</div><div class="line">106</div><div class="line">107</div><div class="line">108</div><div class="line">109</div><div class="line">110</div><div class="line">111</div><div class="line">112</div><div class="line">113</div><div class="line">114</div><div class="line">115</div><div class="line">116</div><div class="line">117</div><div class="line">118</div><div class="line">119</div><div class="line">120</div><div class="line">121</div><div class="line">122</div><div class="line">123</div><div class="line">124</div><div class="line">125</div><div class="line">126</div><div class="line">127</div><div class="line">128</div><div class="line">129</div><div class="line">130</div><div class="line">131</div><div class="line">132</div><div class="line">133</div><div class="line">134</div><div class="line">135</div><div class="line">136</div><div class="line">137</div><div class="line">138</div><div class="line">139</div><div class="line">140</div><div class="line">141</div><div class="line">142</div><div class="line">143</div><div class="line">144</div><div class="line">145</div><div class="line">146</div><div class="line">147</div><div class="line">148</div><div class="line">149</div><div class="line">150</div><div class="line">151</div><div class="line">152</div><div class="line">153</div><div class="line">154</div><div class="line">155</div><div class="line">156</div><div class="line">157</div><div class="line">158</div><div class="line">159</div><div class="line">160</div><div class="line">161</div><div class="line">162</div><div class="line">163</div><div class="line">164</div><div class="line">165</div><div class="line">166</div></pre></td><td class="code"><pre><div class="line">FROM debian:wheezy</div><div class="line">MAINTAINER Steeve Morin &quot;steeve.morin@gmail.com&quot;</div><div class="line"></div><div class="line">RUN apt-get update &amp;&amp; apt-get -y install  unzip \</div><div class="line">                    xz-utils \</div><div class="line">                    curl \</div><div class="line">                    bc \</div><div class="line">                    git \</div><div class="line">                    build-essential \</div><div class="line">                    cpio \</div><div class="line">                    gcc-multilib libc6-i386 libc6-dev-i386 \</div><div class="line">                    kmod \</div><div class="line">                    squashfs-tools \</div><div class="line">                    genisoimage \</div><div class="line">                    xorriso \</div><div class="line">                    syslinux \</div><div class="line">                    automake \</div><div class="line">                    pkg-config</div><div class="line"></div><div class="line">ENV KERNEL_VERSION  3.16.1</div><div class="line">ENV AUFS_BRANCH     aufs3.16</div><div class="line"></div><div class="line"># Fetch the kernel sources</div><div class="line">RUN curl --retry 10 https://www.kernel.org/pub/linux/kernel/v3.x/linux-$KERNEL_VERSION.tar.xz | tar -C / -xJ &amp;&amp; \</div><div class="line">mv /linux-$KERNEL_VERSION /linux-kernel</div><div class="line"></div><div class="line"># Download AUFS and apply patches and files, then remove it</div><div class="line">RUN git clone -b $AUFS_BRANCH --depth 1 git://git.code.sf.net/p/aufs/aufs3-standalone &amp;&amp; \</div><div class="line">cd aufs3-standalone &amp;&amp; \</div><div class="line">cd /linux-kernel &amp;&amp; \</div><div class="line">cp -r /aufs3-standalone/Documentation /linux-kernel &amp;&amp; \</div><div class="line">cp -r /aufs3-standalone/fs /linux-kernel &amp;&amp; \</div><div class="line">cp -r /aufs3-standalone/include/uapi/linux/aufs_type.h /linux-kernel/include/uapi/linux/ &amp;&amp;\</div><div class="line">for patch in aufs3-kbuild aufs3-base aufs3-mmap aufs3-standalone aufs3-loopback; do \</div><div class="line">    patch -p1 &lt; /aufs3-standalone/$patch.patch; \</div><div class="line">done</div><div class="line"></div><div class="line">COPY kernel_config /linux-kernel/.config</div><div class="line"></div><div class="line">RUN jobs=$(nproc); \</div><div class="line">cd /linux-kernel &amp;&amp; \</div><div class="line">make -j $&#123;jobs&#125; oldconfig &amp;&amp; \</div><div class="line">make -j $&#123;jobs&#125; bzImage &amp;&amp; \</div><div class="line">make -j $&#123;jobs&#125; modules</div><div class="line"></div><div class="line"># The post kernel build process</div><div class="line"></div><div class="line">ENV ROOTFS          /rootfs</div><div class="line">ENV TCL_REPO_BASE   http://tinycorelinux.net/5.x/x86</div><div class="line">ENV TCZ_DEPS        iptables \</div><div class="line">                iproute2 \</div><div class="line">                openssh openssl-1.0.0 \</div><div class="line">                tar \</div><div class="line">                gcc_libs \</div><div class="line">                acpid \</div><div class="line">                xz liblzma \</div><div class="line">                git expat2 libiconv libidn libgpg-error libgcrypt libssh2 \</div><div class="line">                nfs-utils tcp_wrappers portmap rpcbind libtirpc \</div><div class="line">                curl ntpclient</div><div class="line"></div><div class="line"># Make the ROOTFS</div><div class="line">RUN mkdir -p $ROOTFS</div><div class="line"></div><div class="line"># Install the kernel modules in $ROOTFS</div><div class="line">RUN cd /linux-kernel &amp;&amp; \</div><div class="line">make INSTALL_MOD_PATH=$ROOTFS modules_install firmware_install</div><div class="line"></div><div class="line"># Remove useless kernel modules, based on unclejack/debian2docker</div><div class="line">RUN cd $ROOTFS/lib/modules &amp;&amp; \</div><div class="line">rm -rf ./*/kernel/sound/* &amp;&amp; \</div><div class="line">rm -rf ./*/kernel/drivers/gpu/* &amp;&amp; \</div><div class="line">rm -rf ./*/kernel/drivers/infiniband/* &amp;&amp; \</div><div class="line">rm -rf ./*/kernel/drivers/isdn/* &amp;&amp; \</div><div class="line">rm -rf ./*/kernel/drivers/media/* &amp;&amp; \</div><div class="line">rm -rf ./*/kernel/drivers/staging/lustre/* &amp;&amp; \</div><div class="line">rm -rf ./*/kernel/drivers/staging/comedi/* &amp;&amp; \</div><div class="line">rm -rf ./*/kernel/fs/ocfs2/* &amp;&amp; \</div><div class="line">rm -rf ./*/kernel/net/bluetooth/* &amp;&amp; \</div><div class="line">rm -rf ./*/kernel/net/mac80211/* &amp;&amp; \</div><div class="line">rm -rf ./*/kernel/net/wireless/*</div><div class="line"></div><div class="line"># Install libcap</div><div class="line">RUN curl -L ftp://ftp.de.debian.org/debian/pool/main/libc/libcap2/libcap2_2.22.orig.tar.gz | tar -C / -xz &amp;&amp; \</div><div class="line">cd /libcap-2.22 &amp;&amp; \</div><div class="line">sed -i &apos;s/LIBATTR := yes/LIBATTR := no/&apos; Make.Rules &amp;&amp; \</div><div class="line">sed -i &apos;s/\(^CFLAGS := .*\)/\1 -m32/&apos; Make.Rules &amp;&amp; \</div><div class="line">make &amp;&amp; \</div><div class="line">mkdir -p output &amp;&amp; \</div><div class="line">make prefix=`pwd`/output install &amp;&amp; \</div><div class="line">mkdir -p $ROOTFS/usr/local/lib &amp;&amp; \</div><div class="line">cp -av `pwd`/output/lib64/* $ROOTFS/usr/local/lib</div><div class="line"></div><div class="line"># Make sure the kernel headers are installed for aufs-util, and then build it</div><div class="line">RUN cd /linux-kernel &amp;&amp; \</div><div class="line">make INSTALL_HDR_PATH=/tmp/kheaders headers_install &amp;&amp; \</div><div class="line">cd / &amp;&amp; \</div><div class="line">git clone git://git.code.sf.net/p/aufs/aufs-util &amp;&amp; \</div><div class="line">cd /aufs-util &amp;&amp; \</div><div class="line">git checkout aufs3.9 &amp;&amp; \</div><div class="line">CPPFLAGS=&quot;-m32 -I/tmp/kheaders/include&quot; CLFAGS=$CPPFLAGS LDFLAGS=$CPPFLAGS make &amp;&amp; \</div><div class="line">DESTDIR=$ROOTFS make install &amp;&amp; \</div><div class="line">rm -rf /tmp/kheaders</div><div class="line"></div><div class="line"># Download the rootfs, don&apos;t unpack it though:</div><div class="line">RUN curl -L -o /tcl_rootfs.gz $TCL_REPO_BASE/release/distribution_files/rootfs.gz</div><div class="line"></div><div class="line"># Install the TCZ dependencies</div><div class="line">RUN for dep in $TCZ_DEPS; do \</div><div class="line">echo &quot;Download $TCL_REPO_BASE/tcz/$dep.tcz&quot; &amp;&amp;\</div><div class="line">    curl -L -o /tmp/$dep.tcz $TCL_REPO_BASE/tcz/$dep.tcz &amp;&amp; \</div><div class="line">    unsquashfs -f -d $ROOTFS /tmp/$dep.tcz &amp;&amp; \</div><div class="line">    rm -f /tmp/$dep.tcz ;\</div><div class="line">done</div><div class="line"></div><div class="line">COPY VERSION $ROOTFS/etc/version</div><div class="line"></div><div class="line"># Get the Docker version that matches our boot2docker version</div><div class="line"># Note: `docker version` returns non-true when there is no server to ask</div><div class="line">RUN curl -L -o $ROOTFS/usr/local/bin/docker https://get.docker.io/builds/Linux/x86_64/docker-$(cat $ROOTFS/etc/version) &amp;&amp; \</div><div class="line">chmod +x $ROOTFS/usr/local/bin/docker &amp;&amp; \</div><div class="line">&#123; $ROOTFS/usr/local/bin/docker version || true; &#125;</div><div class="line"></div><div class="line"># get generate_cert</div><div class="line">RUN curl -L -o $ROOTFS/usr/local/bin/generate_cert https://github.com/SvenDowideit/generate_cert/releases/download/0.1/generate_cert-0.1-linux-386/ &amp;&amp; \</div><div class="line">chmod +x $ROOTFS/usr/local/bin/generate_cert</div><div class="line"></div><div class="line"># Get the git versioning info</div><div class="line">COPY .git /git/.git</div><div class="line">RUN cd /git &amp;&amp; \</div><div class="line">GIT_BRANCH=$(git rev-parse --abbrev-ref HEAD) &amp;&amp; \</div><div class="line">GITSHA1=$(git rev-parse --short HEAD) &amp;&amp; \</div><div class="line">DATE=$(date) &amp;&amp; \</div><div class="line">echo &quot;$&#123;GIT_BRANCH&#125; : $&#123;GITSHA1&#125; - $&#123;DATE&#125;&quot; &gt; $ROOTFS/etc/boot2docker</div><div class="line"></div><div class="line">COPY rootfs/isolinux /isolinux</div><div class="line"></div><div class="line"># Copy our custom rootfs</div><div class="line">COPY rootfs/rootfs $ROOTFS</div><div class="line"></div><div class="line"># These steps can only be run once, so can&apos;t be in make_iso.sh (which can be run in chained Dockerfiles)</div><div class="line"># see https://github.com/boot2docker/boot2docker/blob/master/doc/BUILD.md</div><div class="line">RUN    \</div><div class="line"># Make sure init scripts are executable &amp;&amp; \</div><div class="line">find $ROOTFS/etc/rc.d/ $ROOTFS/usr/local/etc/init.d/ -exec chmod +x &apos;&#123;&#125;&apos; &apos;;&apos; &amp;&amp; \</div><div class="line"># Download Tiny Core Linux rootfs  &amp;&amp; \</div><div class="line">( cd $ROOTFS &amp;&amp; zcat /tcl_rootfs.gz | cpio -f -i -H newc -d --no-absolute-filenames ) &amp;&amp; \</div><div class="line"># Change MOTD &amp;&amp; \</div><div class="line">mv $ROOTFS/usr/local/etc/motd $ROOTFS/etc/motd &amp;&amp; \</div><div class="line"># Make sure we have the correct bootsync &amp;&amp; \</div><div class="line">mv $ROOTFS/boot*.sh $ROOTFS/opt/ &amp;&amp; \</div><div class="line">chmod +x $ROOTFS/opt/*.sh &amp;&amp; \</div><div class="line"># Make sure we have the correct shutdown &amp;&amp; \</div><div class="line">mv $ROOTFS/shutdown.sh $ROOTFS/opt/shutdown.sh &amp;&amp; \</div><div class="line">chmod +x $ROOTFS/opt/shutdown.sh &amp;&amp; \</div><div class="line"># Add serial console &amp;&amp; \</div><div class="line">echo &quot;#!/bin/sh&quot; &gt; $ROOTFS/usr/local/bin/autologin &amp;&amp; \</div><div class="line">echo &quot;/bin/login -f docker&quot; &gt;&gt; $ROOTFS/usr/local/bin/autologin &amp;&amp; \</div><div class="line">chmod 755 $ROOTFS/usr/local/bin/autologin &amp;&amp; \</div><div class="line">echo &apos;ttyS0:2345:respawn:/sbin/getty -l /usr/local/bin/autologin 9600 ttyS0 vt100&apos; &gt;&gt; $ROOTFS/etc/inittab &amp;&amp; \</div><div class="line"># fix su - &amp;&amp; \</div><div class="line">echo root &gt; $ROOTFS/etc/sysconfig/superuser</div><div class="line"></div><div class="line"></div><div class="line">COPY rootfs/make_iso.sh /</div><div class="line">RUN /make_iso.sh</div><div class="line">CMD [&quot;cat&quot;, &quot;boot2docker.iso&quot;]</div></pre></td></tr></table></figure>
</div></article></div></section><footer><div class="paginator"><a href="/2015/09/23/c-note1/" class="prev">PRVE</a><a href="/2015/09/01/hadoop-note/" class="next">NEXT</a></div><div id="disqus_thread"></div><script>var disqus_shortname = 'mcl';
var disqus_identifier = '2015/09/16/docker-file-note/';
var disqus_title = '创建Dockerfile';
var disqus_url = 'http://www.mclspace.com/2015/09/16/docker-file-note/';
(function() {
    var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
    dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
    (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
})();</script><script id="dsq-count-scr" src="//mcl.disqus.com/count.js" async></script><div class="copyright"><p>© 2015 - 2016 <a href="http://www.mclspace.com">LinChen</a>, unless otherwise noted.</p></div></footer><script>var _hmt = _hmt || [];(function() {var hm = document.createElement("script");hm.src = "//hm.baidu.com/hm.js?6b26d13232555e4d64b5a8c3567ccda9";var s = document.getElementsByTagName("script")[0]; s.parentNode.insertBefore(hm, s);})();</script><script src="https://cdn.bootcss.com/mathjax/2.5.3/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script></body></html>