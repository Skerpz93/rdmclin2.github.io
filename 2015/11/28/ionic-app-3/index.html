<!doctype html>
<html class="theme-next use-motion theme-next-mist">
<head>
  

<meta charset="UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>


  <meta name="google-site-verification" content="Bu7qMjAWOJ5dxHauDW_IGiKlJ8kSN5myZ3RxIIAb4Qw" />





  <link rel="stylesheet" type="text/css" href="/vendors/fancybox/source/jquery.fancybox.css?v=2.1.5"/>




<link rel="stylesheet" type="text/css" href="/css/main.css?v=0.4.3"/>


    <meta name="description" content="人生不只眼前的苟且，还有音乐和远方。" />



  <meta name="keywords" content="ionic,mongodb,nodejs," />





  <link rel="shorticon icon" type="image/x-icon" href="/favicon.ico?v=0.4.3" />



<script type="text/javascript" id="hexo.configuration">
  var CONFIG = {
    scheme: 'Mist',
    analytics: {
      google: ''
    },
    sidebar: 'hide'
  };
</script>


  <script type="text/javascript">
    var _hmt = _hmt || [];
    (function() {
      var hm = document.createElement("script");
      hm.src = "//hm.baidu.com/hm.js?6b26d13232555e4d64b5a8c3567ccda9";
      var s = document.getElementsByTagName("script")[0];
      s.parentNode.insertBefore(hm, s);
    })();
  </script>



  <title> Ionic+Nodejs+Mongod开发端到端混合应用系列教程四 - 客户端实现 // Mcl's space </title>
</head>

<body>
  <!--[if lte IE 8]>
  <div style=' clear: both; height: 59px; padding:0 0 0 15px; position: relative;margin:0 auto;'>
    <a href="http://windows.microsoft.com/en-US/internet-explorer/products/ie/home?ocid=ie6_countdown_bannercode">
      <img src="http://7u2nvr.com1.z0.glb.clouddn.com/picouterie.jpg" border="0" height="42" width="820"
           alt="You are using an outdated browser. For a faster, safer browsing experience, upgrade for free today or use other browser ,like chrome firefox safari."
           style='margin-left:auto;margin-right:auto;display: block;'/>
    </a>
  </div>
<![endif]-->

  <div class="container one-column page-post-detail">
    <div class="headband"></div>

    <div id="header" class="header">
      <div class="header-inner">
        <h1 class="site-meta">
  <span class="logo-line-before"><i></i></span>
  <a href="/" class="brand">
      <span class="logo">
        <i class="icon-logo"></i>
      </span>
      <span class="site-title">Mcl's space</span>
  </a>
  <span class="logo-line-after"><i></i></span>
</h1>

<div class="site-nav-toggle">
  <button>
    <span class="btn-bar"></span>
    <span class="btn-bar"></span>
    <span class="btn-bar"></span>
  </button>
</div>

<div class="site-nav">
  

  
    <ul id="menu" class="menu menu-left">
      
        
        <li class="menu-item menu-item-home">
          <a href="/">
            <i class="menu-item-icon icon-home"></i> <br />
            首页
          </a>
        </li>
      
        
        <li class="menu-item menu-item-archives">
          <a href="/archives">
            <i class="menu-item-icon icon-archives"></i> <br />
            归档
          </a>
        </li>
      
        
        <li class="menu-item menu-item-tags">
          <a href="/tags">
            <i class="menu-item-icon icon-tags"></i> <br />
            标签
          </a>
        </li>
      
        
        <li class="menu-item menu-item-about">
          <a href="/about">
            <i class="menu-item-icon icon-about"></i> <br />
            关于
          </a>
        </li>
      
    </ul>
  

  
    <div class="site-search">
      
  
<form class="site-search-form">
  <input type="text" id="st-search-input" class="st-search-input st-default-search-input" />
</form>
<script type="text/javascript">
  (function(w,d,t,u,n,s,e){w['SwiftypeObject']=n;w[n]=w[n]||function(){
    (w[n].q=w[n].q||[]).push(arguments);};s=d.createElement(t);
    e=d.getElementsByTagName(t)[0];s.async=1;s.src=u;e.parentNode.insertBefore(s,e);
  })(window,document,'script','//s.swiftypecdn.com/install/v2/st.js','_st');

  _st('install', 'f1j4RSGQfz6oqaev5X_Q','2.0.0');
</script>

<div class="site-search-toggle"></div>
    </div>
  
</div>


      </div>
    </div>

    <div id="main" class="main">
      <div class="main-inner">
        <div id="content" class="content">
          

  <div id="posts" class="posts-expand">
    

  <div class="post post-type-normal ">
    <div class="post-header">

      
      
        <h1 class="post-title">
          
          
            
              Ionic+Nodejs+Mongod开发端到端混合应用系列教程四 - 客户端实现
            
          
        </h1>
      

      <div class="post-meta">
        <span class="post-time">
          发表于 Nov 28 2015
        </span>

        
          <span class="post-category">
            &nbsp; | &nbsp; 分类于
            
              <a href="/categories/ionic/">ionic</a>

              
              

            
          </span>
        

        
          
            <span class="post-comments-count">
            &nbsp; | &nbsp;
            <a href="/2015/11/28/ionic-app-3/#comments" >
              <span class="post-comments-count disqus-comment-count" data-disqus-identifier="2015/11/28/ionic-app-3/"></span>
            </a>
          </span>
          
        
      </div>
    </div>

    <div class="post-body">

      
      

      
        <blockquote>
<p>本篇为Ionic App 系列教程的客户端实现部分,我们使用Ionic框架进行客户端实现，Ionic本身依赖Ionic和AngularJS。</p>
<p>我已经把项目文件整理起来放到<a href="https://github.com/rdmclin2/fcws" target="_blank" rel="external">github</a>上了，供大家参考。</p>
</blockquote>
<a id="more"></a>
<h1 id="工程文件结构">工程文件结构</h1><p>首先我们来讲解客户端的代码结构，代码结构如下所示:<br><img src="http://7pun7p.com1.z0.glb.clouddn.com/hexo/client.png" alt=""><br>图中工程结构部分大部分为ionic框架自动生成的部分，我们编写代码主要是在www文件夹中，因此下面我们解析www的文件结构，如下:</p>
<ul>
<li>css 该文件夹存放css文件，css文件可以用来修改页面显示的效果</li>
<li>img 该文件夹存放图片文件，工程中所有引用的图片都放在这个文件夹中</li>
<li>js 该文件夹主要存放工程的逻辑代码</li>
<li>controllers js的子文件夹，该文件夹存放每个页面的控制逻辑</li>
<li>services js的子文件夹，该文件夹存放工程共有的任务，我们称为服务。</li>
<li>utils js的子文件夹，该文件夹存放工具类.</li>
<li>app.js js的子文件夹，该文件是angularjs的入口文件，配置了工程相关属性，如路由控制等</li>
<li>templates 该文件夹存放所有的UI界面，均为html文件。</li>
</ul>
<h1 id="创建项目">创建项目</h1><p>使用ionic的start命令初始化工程</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ ionic start express_client sidemenu</span><br></pre></td></tr></table></figure>
<p>该命令会帮你初始化一个工程，添加ionic的项目组件，并用sidemenu项目初始化。sidemenu是一个示例文件，帮助开发者开速地开始工程构建，默认添加侧边栏效果。ionic给我们提供了很多方便的命令，如:</p>
<ul>
<li><code>$ ionic setup sass</code> 添加sass支持</li>
<li><code>$ ionic serve</code> 在浏览器中实时查看</li>
<li><code>$ ionic platform add ios [android]</code> 添加相关平台</li>
<li><code>$ ionic build &lt;PLATFORM&gt;</code> 编译具体的某个平台</li>
<li><code>$ ionic emulate &lt;PLATFORM&gt;</code> 在模拟器中运行程序</li>
<li><code>$ ionic run &lt;PLATFORM&gt;</code> 在真机上运行程序</li>
</ul>
<h1 id="创建工具类">创建工具类</h1><p>在我们的utils文件夹中有一个storage.js的类，这个类用来提供我们应用的本地存储，本地存储是区别于数据库的持久化存储的一种存储方式，我们将数据存储在本地，即使没有网络，在下次打开应用的时候，仍然能够读取到之前浏览的数据.其代码如下所示:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">angular.module(&#39;fcws.utils&#39;, [])&#10;&#10;.factory(&#39;$localstorage&#39;, [&#39;$window&#39;, function($window) &#123;&#10;  return &#123;&#10;    set: function(key, value) &#123;&#10;      $window.localStorage[key] = JSON.stringify(value);&#10;    &#125;,&#10;    get: function(key) &#123;&#10;      return JSON.parse($window.localStorage[key] || &#39;&#123;&#125;&#39;);&#10;    &#125;,&#10;    remove: function(key) &#123;&#10;      return window.localStorage.removeItem(key);&#10;    &#125;&#10;  &#125;;&#10;&#125;]);</span><br></pre></td></tr></table></figure>
<p>我们创建了一个$localStorage的工厂类,并添加了set,get,remove的方法分别为设置，获取，移除本地存储的键值对。</p>
<h1 id="入口页面">入口页面</h1><p>www文件夹下的index.html是我们的默认入口页面，在创建工程时默认会创建，在该页面中我们可以加载自己的脚本。要使用angular和ionic我们需要加载ionic库:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#60;!-- ionic/angularjs js    --&#62;&#10;&#60;script src=&#34;lib/ionic/js/ionic.bundle.js&#34;&#62;&#60;/script&#62;</span><br></pre></td></tr></table></figure>
<p>ionic库中包含angular的脚本，因此这里我们不需要重复加载angular。然后加载cordova.js库:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#60;!-- cordova script (this will be a 404 during development) --&#62;&#10;&#60;script src=&#34;cordova.js&#34;&#62;&#60;/script&#62;</span><br></pre></td></tr></table></figure>
<p>cordova库给予了js以访问设备底层api的能力，使hybird app的概念称为可能。然后加载css资源:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#60;link href=&#34;lib/ionic/css/ionic.css&#34; rel=&#34;stylesheet&#34;&#62;&#10;&#60;link href=&#34;css/style.css&#34; rel=&#34;stylesheet&#34;&#62;</span><br></pre></td></tr></table></figure>
<p>这里我们用到了ionic提供的ionic.css文件，我们自己的样式css定义在style.css文件中。然后加载我们的app.js:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#60;!-- your app&#39;s js --&#62;&#10;&#60;script src=&#34;js/app.js&#34;&#62;&#60;/script&#62;</span><br></pre></td></tr></table></figure>
<p>这是我们应用的入口文件，这里定义了和应用有关的各个部分。最后所有的我们用到的控制器和服务等都在这里进行加载,由于数量过多，例举如下:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#60;!-- services: --&#62;&#10;&#60;script src=&#34;js/services/API.js&#34;&#62;&#60;/script&#62;&#10;&#60;script src=&#34;js/services/Camera.js&#34;&#62;&#60;/script&#62;&#10;&#60;script src=&#34;js/services/Docs.js&#34;&#62;&#60;/script&#62;&#10;...&#10;&#60;!-- controllers --&#62;&#10;&#60;script src=&#34;js/controllers/auth/auth.js&#34;&#62;&#60;/script&#62;&#10;&#60;script src=&#34;js/controllers/auth/login.js&#34;&#62;&#60;/script&#62;&#10;&#60;script src=&#34;js/controllers/auth/signup.js&#34;&#62;&#60;/script&#62;&#10;...&#10;&#60;!-- utils --&#62;&#10;&#60;script src=&#34;js/utils/storage.js&#34;&#62;&#60;/script&#62;</span><br></pre></td></tr></table></figure>
<p>之后我们需要用ng-app指令来定义angular应用的边界:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#60;body ng-app=&#34;fcws&#34;&#62;&#10;&#60;ion-nav-view &#62;&#60;/ion-nav-view&#62;&#10;&#60;/body&#62;</span><br></pre></td></tr></table></figure>
<p>这里我们应用的边界为body,用名为fcws的app进行管理。</p>
<h1 id="app-js">app.js</h1><p>app.js是应用的配置文件，在这里我们定义app的名字，加载对应的服务，进行相应的设置，设定页面的路由，配置服务器常量。下面分部分具体描述。</p>
<h2 id="定义app顶层模块">定义app顶层模块</h2><p>下面的代码使用angular.module声明了一个名为fcws的模块，该模块即我们上文中ng-app使用的app的名称，app名称后面的类是该模块依赖的其他模块，这种方式叫依赖注入。ionic模块是ionic提供的模块,以fcws开头的是我们为该app编写的控制器，服务器，工具模块，其他模块为导入的库模块。<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">angular.module(&#39;fcws&#39;, [&#10;  &#39;ionic&#39;,&#10;  &#39;fcws.controllers&#39;,&#10;  &#39;fcws.services&#39;,&#10;  &#39;fcws.utils&#39;,&#10;  &#39;angularMoment&#39;,&#10;  &#39;ngCordova&#39;&#10;])</span><br></pre></td></tr></table></figure></p>
<h2 id="运行配置">运行配置</h2><p>下面代码中的run是ionic用来配置app运行设置的函数，一些配置项可以在应用启动前进行配置，例如<code>amMoment.changeLocale(&#39;zh-cn&#39;);</code>这句代码配置amMoment模块的时区为zh-cn即中国。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">.run(function($ionicPlatform,amMoment) &#123;&#10;  // change language to zh-cn&#10;  amMoment.changeLocale(&#39;zh-cn&#39;);&#10;&#10;  $ionicPlatform.ready(function() &#123;&#10;&#10;    // Hide the accessory bar by default (remove this to show the accessory bar above the keyboard&#10;    // for form inputs)&#10;    if (window.cordova &#38;&#38; window.cordova.plugins.Keyboard) &#123;&#10;      cordova.plugins.Keyboard.hideKeyboardAccessoryBar(true);&#10;    &#125;&#10;    if (window.StatusBar) &#123;&#10;      StatusBar.styleDefault();&#10;    &#125;&#10;  &#125;);&#10;&#125;)</span><br></pre></td></tr></table></figure>
<h2 id="路由">路由</h2><p>各个页面的路由也在app.js中的config函数中配置,我们使用angular提供的$stateProvider, $urlRouterProvider进行状态路由配置，一个状态由它的状态名，对应的url，对应的页面文件的url和一个用于控制的控制器组成。一些状态可能不止一个UI界面区域，需要用views{}进行组合。该函数是整个app的胶水，将控制器，界面和url绑定在了一起。$ionicConfigProvider是ionic提供的ionic界面的控制器,这里我们使用该模块将界面中的标题全部居中，默认情况下安卓偏左，ios居中，我们使用该代码获得一致的体验。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">.config(function($stateProvider, $urlRouterProvider,$ionicConfigProvider) &#123;&#10;&#10;  $ionicConfigProvider.navBar.alignTitle(&#39;center&#39;);&#10;&#10;  $stateProvider&#10;  // login page&#10;  .state(&#39;signin&#39;, &#123;&#10;    url: &#34;/signin&#34;,&#10;    templateUrl: &#39;templates/auth/signin.html&#39;,&#10;    controller: &#39;LogInCtrl&#39;&#10;  &#125;)&#10;&#10;  .state(&#39;sidemenu.changepw&#39;, &#123;&#10;    url: &#34;/changepw&#34;,&#10;    views: &#123;&#10;      &#39;menuContent&#39;: &#123;&#10;        templateUrl: &#39;templates/auth/changepw.html&#39;,&#10;        controller: &#39;ChangepwCtrl&#39;&#10;        &#125;&#10;      &#125;&#10;    &#125;)&#10;  ...</span><br></pre></td></tr></table></figure>
<h2 id="服务器常量配置">服务器常量配置</h2><p>app.js中可以用.constant定义常量,这里我们定义了SERVER常量,配置我们后面要用到的和服务器相关的常量，如api,docs等，在本地服务器和远程服务器之间进行切换。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">.constant(&#39;SERVER&#39;, &#123;&#10;  // if using local server&#10;   api: &#39;http://localhost:9804/api/v1&#39;,&#10;   docs:&#39;http://localhost:9804/docs&#39;&#10;&#10;  // if using our public heroku server&#10; // api: &#39;http://nemoworks.info:9804/api/v1&#39;,&#10; // docs:&#39;http://nemoworks.info:9804/docs&#39;,&#10;&#125;);</span><br></pre></td></tr></table></figure>
<h1 id="用户登录">用户登录</h1><p>要实现用户登录功能,我们首先编写用户登录的页面，用户页面使用HTML编写，由于Angular的管理，我们可以在页面中插入模型和数据，将界面和后台的数据结合起来，另外ionic提供了一些区别于HTML标记的新标记，让我们可以通过Ionic渲染界面，具体的用户界面如下:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#60;ion-view&#62;&#10;  &#60;ion-header-bar class=&#34;bar-positive&#34; align-title=&#34;center&#34;&#62;&#10;    &#60;h1 class=&#34;title&#34;&#62;&#30331;&#24405;&#60;/h1&#62;&#10;  &#60;/ion-header-bar&#62;&#10;&#10;  &#60;ion-content class=&#34;signup-page&#34; scroll=&#34;false&#34;&#62;&#10;    &#60;label class=&#34;item item-input username&#34;&#62;&#10;      &#60;i class=&#34;icon ion-ios-person-outline positive&#34;&#62;&#60;/i&#62;&#10;      &#60;input type=&#34;text&#34; placeholder=&#34;&#32534;&#21495;&#34; ng-model=&#34;user.id&#34;&#62;&#10;    &#60;/label&#62;&#10;    &#60;br&#62;&#10;    &#10;    &#60;label class=&#34;item item-input lock&#34;&#62;&#10;      &#60;i class=&#34;icon ion-ios-locked-outline balanced&#34;&#62;&#60;/i&#62;&#10;      &#60;input type=&#34;password&#34; placeholder=&#34;&#23494;&#30721;&#34; ng-model=&#34;user.password&#34;&#62;&#10;    &#60;/label&#62;&#10;      &#10;    &#60;button class=&#34;button button-block button-positive&#34; ng-click=&#34;validateUser()&#34;&#62;&#10;      &#30331;&#24405;&#10;    &#60;/button&#62;&#10;&#10;  &#60;/ion-content&#62;&#10;&#60;/ion-view&#62;</span><br></pre></td></tr></table></figure>
<p>上面的代码中我们使用<ion-view>定义了一个ionic类型的视图,<ion-header-bar>定义了一个顶部栏,<ion-content>定义了内容区域，另外class中的item,item-input,button-block等类型也是ionic特定的类型，添加这些类型之后可以获得我们想要的效果。另外注意到ng-model这个标记，这个标记将页面上的input的数据和后台的数据联系起来了，在后台改变该数据，页面也会刷新，在页面上改变该数据，后台也会刷新该数据，这种特性称为双向绑定。还有button标签中的ng-click，该指令允许你点击该button之后触发validateUser方法，我们用该方法来验证表单，触发登陆操作。<br>另外我们在该页面中还使用了css为我们的页面添加效果，如下:</ion-content></ion-header-bar></ion-view></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">.signup-page &#123;&#10;  text-align: center;&#10;  background-size: cover;&#10;  background-repeat: no-repeat;&#10;  background-position: center;&#10;&#125;&#10;&#10;.signup-page &#123;&#10;  width: 88%;&#10;  margin: 20% auto 30px auto;&#10;&#125;&#10;&#10;.signup-page label.username&#123;&#10;    border-top: 0;&#10;    border-bottom: 1px solid rgb(81,122,245);&#10;&#125;&#10;&#10;.signup-page label.lock&#123;&#10;    border-top: 0;&#10;    border-bottom: 1px solid rgb(131,209,118);&#10;&#125;&#10;&#10;.signup-page  label.username i,.signup-page label.lock i&#123;&#10;  margin-right: 15px;&#10;  font-size: 25px;&#10;&#125;&#10;&#10;.signup-page .button &#123;&#10;  margin: 20px auto;&#10;&#125;</span><br></pre></td></tr></table></figure>
<p>为了在载入应用之后首先进入登陆页面，我们在app.js中的.config函数中增加如下语句:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$urlRouterProvider.otherwise(&#39;/signin&#39;);</span><br></pre></td></tr></table></figure>
<p>这句代码表示在没有指定url的情况下，默认进入signin状态,下面我们定义signin状态:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">.state(&#39;signin&#39;, &#123;&#10;  url: &#34;/signin&#34;,&#10;  templateUrl: &#39;templates/auth/signin.html&#39;,&#10;  controller: &#39;LogInCtrl&#39;&#10;&#125;)</span><br></pre></td></tr></table></figure>
<p>这段代码定义了一个称为signin的状态，这个状态对应的url为<ip signin="">,该url对应的页面的地址为templates/auth/signin.html,该状态对应的控制器为LogInCtrl。下面我们定义LogInCtrl,代码如下:</ip></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">angular.module(&#39;fcws.controllers&#39;)&#10;/*&#10;Controller for the User page&#10;*/&#10;.controller(&#39;LogInCtrl&#39;, function($rootScope, $scope, $window,User,API) &#123;&#10;    // if the user is already logged in, take him to his dashboard&#10;    if (User.isAuthenticated()) &#123;&#10;      $window.location.href = (&#39;#/sidemenu/dashboard&#39;);&#10;    &#125;&#10;        &#10;    $scope.user = &#123;&#10;      id : &#34;&#34;,&#10;      password : &#34;&#10;    &#34;&#10;    &#125;;&#10;  $scope.validateUser = function() &#123;&#10;    var id = this.user.id;&#10;    var password = this.user.password;&#10;    if (!id || !password) &#123;&#10;      $rootScope.notify(&#34;&#35831;&#36755;&#20837;&#23436;&#25972;&#20449;&#24687;&#34;);&#10;      return &#10;      false;&#10;    &#125;&#10;    $rootScope.show(&#39;&#30331;&#24405;&#20013;...&#35831;&#31245;&#20505;&#39;);&#10;    User.signin(&#123;&#10;      id: id,&#10;      password: password&#10;    &#125;).success(function(data) &#123;&#10;      User.loginUser(data._id,data.id,data.name,data.title,data.belong,data.isLeader);&#10;      $rootScope.hide();&#10;      $window.location.href = (&#39;#/sidemenu/dashboard&#39;);&#10;    &#125;).error(function(error) &#123;&#10;      $rootScope.hide();&#10;      $rootScope.notify(&#34;&#26080;&#25928;&#30340;&#29992;&#25143;&#21517;&#25110;&#23494;&#30721;&#34;);&#10;    &#125;);&#10;   &#125;;&#10;&#125;);</span><br></pre></td></tr></table></figure>
<p><code>.controller(&#39;LogInCtrl&#39;, function($rootScope, $scope, $window,User,API) {</code>这句代码表示我们定义了一个LogInCtrl控制器,该控制器包含$rootScope,$scope等依赖部件，类似于java中的import。在该控制器中我们首先判断用户是否已经授权登陆了，如果已经登陆则直接跳转到dashboard界面。$scope是目标界面的作用域，我们将数据绑定在这个对象上就能在页面中进行访问，例如这里的$scope.user,我们就可以在界面中ng-model中定义user.id访问该数据。validateUser函数用于验证用户的信息是否正确，如果没有问题则通过User服务向服务器发送登录验证，如果成功则存储用户信息，并且跳转到dashboard,如果失败，则提示用户”无效的用户名或密码”。这里用到了User服务，User是我们定义的用来存储用户信息，验证用户权限，提供和用户有关的函数的服务类。代码如下:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">angular.module(&#39;fcws.services&#39;)&#10;  .factory(&#39;User&#39;, function($q,$localstorage,$log,$rootScope,SERVER,$http) &#123;&#10;    var userKey = &#39;user&#39;;&#10;    var isAuthenticatedKey = &#39;isAuthenticated&#39;;&#10;    var user = $localstorage.get(userKey);&#10;    return &#123;&#10;      signin: function (form) &#123;&#10;          var url = SERVER.api+&#39;/auth/login&#39;;&#10;          console.log(url);&#10;          return $http.post(url, form);&#10;      &#125;,&#10;      signup: function (form) &#123;&#10;          var url = SERVER.api+&#39;/auth/register&#39;;&#10;          console.log(url);&#10;          return $http.post(url, form);&#10;      &#125;,&#10;      //confirm that the inputed password is same as the user&#39;s passwod&#10;      confirmPassword: function (form) &#123;&#10;        var url = SERVER.api+&#39;/auth/confirmpw&#39;;&#10;        console.log(url);&#10;        return $http.post(url, form);&#10;      &#125;,&#10;      //change the password&#10;      changePassword: function (form) &#123;&#10;        var url = SERVER.api+&#39;/auth/changepw&#39;;&#10;        console.log(url);&#10;        return $http.post(url, form);&#10;      &#125;,&#10;      getDetail : function () &#123;&#10;        var token = this.getToken();&#10;        var id = this.getUserId();&#10;        return $http.get(SERVER.api+ &#39;/user/&#39; + id, &#123;&#10;          method: &#39;GET&#39;,&#10;          params: &#123;&#10;              token: token&#10;          &#125;&#10;        &#125;);&#10;      &#125;,&#10;      loginUser: function (_id,id,name,title,belong,isLeader) &#123;&#10;          $log.log(_id + &#34; &#34; + id + &#34; &#34; + name + &#34; &#34; + title+&#34; &#34;+ belong+ &#34; &#34;+ isLeader);&#10;          $localstorage.set(userKey,&#123;_id:_id,id:id,name:name,title:title,belong:belong,isLeader:isLeader&#125;);&#10;          $localstorage.set(isAuthenticatedKey,true);&#10;          user = $localstorage.get(userKey);&#10;          $rootScope.$broadcast(&#39;login&#39;);&#10;      &#125;,&#10;      logoutUser: function () &#123;&#10;        $localstorage.remove(userKey);&#10;        $localstorage.set(isAuthenticatedKey,false);&#10;      &#125;,&#10;      isAuthenticated: function () &#123;&#10;          return $localstorage.get(isAuthenticatedKey);&#10;      &#125;,&#10;      getId : function () &#123;&#10;          return user._id+&#34;&#34;;&#10;      &#125;,&#10;      getUserId : function () &#123;&#10;          return user.id+&#34;&#34;;&#10;      &#125;,&#10;      getUserTitle : function () &#123;&#10;        return user.title || &#34;&#34;;&#10;      &#125;,&#10;      getUserName: function()&#123;&#10;          return user.name || &#34;&#27426;&#36814;&#34;;&#10;      &#125;,&#10;      getBelong : function () &#123;&#10;          return user.belong;&#10;      &#125;,&#10;      isLeader: function () &#123;&#10;          return user.isLeader;&#10;      &#125;,&#10;      getToken: function () &#123;&#10;        //set email as token temperarily&#10;          return user.id;&#10;      &#125;&#10;    &#125;;&#10;  &#125;);</span><br></pre></td></tr></table></figure>
<p>Service的定义方式和Controller很像，区别是Service会暴露出函数供其他部件使用.注意到我们定义了signup,signin，confirmPassword，changePassword，getDetail等方法，这些方法的共性是他们都需要和远程服务器进行通信，我们通过$http模块来发送http请求，该模块封装了一些基本的http方法，如get,post,delete,update等，例如post,首先我们用SERVER中的api地址构造url，和form数据一起传给$http.post方法，这样我们就向url对应的服务器地址发送了一个post请求，并且将form打包发送。服务器收到该请求后会解析该url，传送给相应的函数进行处理，并返回成功或失败。$http的方法会返回一个promise对象，通过该对象我们可以用.success方法和.error方法判断该请求是成功，还是失败，并进行相应的后续操作。<br>另外User中的loginUser和logoutUser是我们将用户数据进行本地存储的函数，当用户登录时，我们将用户数据存在本地，当用户登出时，我们销毁本地数据，注意这里用到了我们在utils文件夹中定义的$localstorage工具类。这个类用来提供我们应用的本地存储，本地存储是区别于数据库的持久化存储的一种存储方式，我们将数据存储在本地，即使没有网络，在下次打开应用的时候，仍然能够读取到之前浏览的数据.到这里，一个用户登录的过程就基本结束了。</p>
<h1 id="情报消息">情报消息</h1><p>情报信息是本app中的重中之重，它包含了发布情报，展示情报，详细情报，情报评论，删除情报等功能。首先我们在app.js中定义和情报有关的状态:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">.state(&#39;sidemenu.posts&#39;, &#123;&#10;  url: &#39;/posts&#39;,&#10;  views: &#123;&#10;    &#39;menuContent&#39;: &#123;&#10;      templateUrl: &#39;templates/post/list.html&#39;,&#10;      controller: &#39;PostsCtrl&#39;&#10;    &#125;&#10;  &#125;&#10;&#125;)&#10;&#10;.state(&#39;sidemenu.post&#39;, &#123;&#10;  url: &#39;/posts/:post_id&#39;,&#10;  views: &#123;&#10;    &#39;menuContent&#39;: &#123;&#10;      templateUrl: &#34;templates/post/detail.html&#34;,&#10;      controller: &#39;PostCtrl&#39;,&#10;    &#125;&#10;  &#125;&#10;&#125;)</span><br></pre></td></tr></table></figure>
<p>这里我们定义了两个状态，一个是sidemenu.posts,该状态的页面存放在menuContent中，对应的展示页面为list.html,相应的控制器为PostsCtrl. 另一个状态是sidemenu.post,该状态的url中有一个post_id的参数，点击具体的某个情报的列表项时，将把相应的id传给该状态，该页面向服务器请求该情报的具体信息进行展示，对应的展示页面为detail.html,控制器为PostCtrl。</p>
<h2 id="情报列表">情报列表</h2><p>首先我们定义情报信息的展示界面,这里我们省略用于展示效果的css:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#60;ion-view view-title=&#34;&#24773;&#25253;&#20449;&#24687;&#34; class=&#34;posts&#34; &#62;&#10;  &#60;ion-nav-buttons side=&#34;left&#34;&#62;&#10;    &#60;button menu-toggle=&#34;left&#34; class=&#34;button button-icon icon ion-navicon&#34;&#62;&#60;/button&#62;&#10;  &#60;/ion-nav-buttons&#62;&#10;  &#60;ion-nav-buttons side=&#34;right&#34;&#62;&#10;    &#60;a class=&#34;button button-clear&#34; ng-click=&#34;showNewPostModal()&#34;&#62;&#10;      &#60;i class=&#34;icon ion-ios-compose-outline&#34;&#62;&#60;/i&#62;&#10;    &#60;/a&#62;&#10;  &#60;/ion-nav-buttons&#62;&#10;  &#60;ion-content class=&#34;content&#34;&#62;&#10;    &#60;ion-refresher  on-refresh=&#34;doRefresh()&#34;&#62;&#60;/ion-refresher&#62;&#10;    &#60;div class=&#34;card&#34; ng-show=&#34;noData&#34;&#62;&#10;        &#60;div class=&#34;item item-text-wrap&#34; &#62;&#10;           &#60;span&#62;&#10;             &#30446;&#21069;&#27809;&#26377;&#20219;&#20309;&#26032;&#30340;&#24773;&#25253;&#65292;&#28857;&#20987;&#21491;&#19978;&#35282;&#30340;&#25353;&#38062;&#21457;&#24067;&#26032;&#30340;&#24773;&#25253;&#10;           &#60;/span&#62;&#10;        &#60;/div&#62;&#10;     &#60;/div&#62;&#10;    &#60;ion-list can-swipe=&#34;true&#34;&#62;&#10;      &#60;div ng-repeat=&#34;post in posts&#34;&#62;&#10;        &#60;a class=&#34;item item-avatar-left&#34; ng-class=&#34;&#123;&#39;important&#39;: post.important&#125;&#34;&#10;        ui-sref=&#39;sidemenu.post(&#123;post_id: post._id&#125;)&#39;&#62;&#10;          &#60;img ng-src=&#34;img/avatar.jpg&#34;&#62;&#10;          &#60;h2&#62;&#10;            &#60;button class= &#34;button button-outline button-assertive button-small&#34;&#10;            ng-if=&#34;post.important&#34;&#62;&#10;            &#32039;&#24613;&#10;            &#60;/button&#62;&#10;            &#60;button class= &#34;button button-outline button-positive button-small&#34;&#10;            ng-if=&#34;!post.important&#34; &#62;&#26085;&#24120;&#60;/button&#62;&#10;            &#123;&#123;post.content | limitTo:lengthLimit&#125;&#125;&#123;&#123;post.content.length &#62; lengthLimit?&#34;...&#34;:&#34;&#34;&#125;&#125;&#10;            &#60;span &#62;&#10;              &#60;i class=&#34;icon ion-ios-heart item-note &#34;&#62;&#10;                &#123;&#123;post.likesCount &#62;0?post.likesCount:0&#125;&#125;&#10;              &#60;/i&#62;&#10;              &#60;i class=&#34;icon ion-chatboxes  item-note&#34;&#62;&#10;                 &#123;&#123;post.replyCount &#62;0?post.replyCount:0&#125;&#125;&#38;nbsp;&#10;               &#60;/i&#62;&#10;            &#60;/span&#62;&#10;          &#60;/h2&#62;&#10;          &#60;p &#62;&#10;            &#60;i class=&#34;icon ion-ios-person-outline positive&#34;&#62;&#60;/i&#62;&#10;            &#123;&#123;post.userName&#125;&#125;&#10;            &#60;span am-time-ago=&#34;post.createDate&#34; class=&#34;item-note&#34;&#62;&#10;            &#60;/span&#62;&#10;          &#60;/p&#62;&#10;        &#60;/a&#62;&#10;      &#60;/div&#62;&#10;    &#60;/ion-list&#62;&#10;    &#60;ion-infinite-scroll on-infinite=&#34;loadMore()&#34; icon=&#34;ion-loading-c&#34;&#10;    ng-if=&#34;hasNextPage &#38;&#38; !loadError&#34;&#62;&#10;    &#60;/ion-infinite-scroll&#62;&#10;  &#60;/ion-content&#62;&#10;&#60;/ion-view&#62;</span><br></pre></td></tr></table></figure>
<p>该页面包括一个侧边栏的导航按钮，一个添加新的情报的添加按钮，以及一个展示情报的列表。<code>ui-sref=&#39;sidemenu.post({post_id: post._id})&#39;</code>该句让我们在点击该情报的时候跳转到情报详情界面，并传入该情报对应的id号，注意到我们在显示时间的时候使用了am-time-ago标签，该标签由moment库提供，能够显示相对时间，要使用此库，只需要在index.html中加载该库所需要的文件:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#60;script src=&#34;lib/moment/min/moment-with-locales.js&#34;&#62;&#60;/script&#62;&#10;&#60;script src=&#34;lib/angular-moment/angular-moment.js&#34;&#62;&#60;/script&#62;</span><br></pre></td></tr></table></figure>
<p>然后在fcws的模块中加入angularMoment的依赖:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">angular.module(&#39;fcws&#39;, [&#10;  &#39;ionic&#39;,&#10;  &#39;fcws.controllers&#39;,&#10;  &#39;fcws.services&#39;,&#10;  &#39;fcws.utils&#39;,&#10;  &#39;angularMoment&#39;,&#10;  &#39;ngCordova&#39;&#10;])</span><br></pre></td></tr></table></figure>
<p>最后在app.js中的run函数中设置我们要显示的时区即可使用该标签即可:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">.run(function($ionicPlatform,amMoment) &#123;&#10;  // change language to zh-cn&#10;  amMoment.changeLocale(&#39;zh-cn&#39;);</span><br></pre></td></tr></table></figure>
<h2 id="分页">分页</h2><p>对于列表项的显示我们不能向服务器一下子请求所有的情报，这样会导致请求的数据过大，不仅占用大量带宽，而且对服务器和客户端都是不小的压力，因此我们需要进行分页，当用户需要浏览更多情报的时候再去服务器加载更多。ionic框架向我们提供了ion-infinite-scroll标签，该标签在用户滑动到页面底部的时候触发loadMore函数，loadmore函数如下:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$scope.loadMore = function()&#123;&#10;    Posts.pagination()&#10;    .success(function(response)&#123;&#10;      $scope.loadError = false;&#10;      $scope.hasNextPage = false;&#10;      $timeout(function() &#123;&#10;        $scope.hasNextPage = Posts.hasNextPage();&#10;        $log.debug(&#39;has next page ? &#39;, $scope.hasNextPage);&#10;     &#125;, 100);&#10;     $scope.posts = $scope.posts.concat(response.data);&#10;    &#125;)&#10;    .error(function()&#123;&#10;      $scope.loadError = true;&#10;      $rootScope.notify(&#34;&#20986;&#38169;&#20102;!!&#35831;&#26816;&#26597;&#32593;&#32476;&#21518;&#37325;&#35797;&#34;);&#10;    &#125;);&#10;    $scope.$broadcast(&#39;scroll.infiniteScrollComplete&#39;);&#10;&#125;;</span><br></pre></td></tr></table></figure>
<p>该函数使用使用Posts服务中的pagination函数,在收到请求的数据后加入到已有列表中并显示,如下:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">pagination: function() &#123;&#10;        console.log(&#34;pagination&#34;);&#10;        var promise = $http.get(SERVER.api + &#39;/posts&#39;,&#123;&#10;          params:&#123;&#10;            page: nextPage,&#10;            limit : limit&#10;          &#125;&#10;        &#125;);&#10;        promise.success(function(response)&#123;&#10;          if(response.data.length &#60; limit)&#123;&#10;            console.log(&#39;posts length: &#39; + response.data.length);&#10;            hasNextPage = false;&#10;          &#125;&#10;          nextPage ++;&#10;          posts = posts.concat(response.data);&#10;        &#125;);&#10;        return promise;&#10;      &#125;,</span><br></pre></td></tr></table></figure>
<p>我们在Posts服务中维护了page变量用于标示目前的分页页数和hasNextPage的布尔值用于标示是否还有下一页,在收到新一页的数据时，我们将它和已有的情报保存在一起。</p>
<h2 id="下拉刷新">下拉刷新</h2><p>注意到在ion-content标签下有一个ion-refresher的标签，即<code>&lt;ion-refresher  on-refresh=&quot;doRefresh()&quot;&gt;&lt;/ion-refresher&gt;</code>,该标签为下拉刷新标签，用户在该界面下拉时会触发doRefresh函数，该函数会向服务器重新请求数据并进行刷新。doRefresh函数定义在PostsCtrl中，如下:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$scope.doRefresh = function() &#123;&#10;  Posts.refresh()&#10;  .success(function(response)&#123;&#10;&#10;      $scope.posts = response.data;&#10;&#10;      if ($scope.posts.length === 0) &#123;&#10;        $scope.noData = true;&#10;      &#125; else &#123;&#10;        $scope.noData = false;&#10;      &#125;&#10;&#10;      $scope.loadError = false;&#10;      $scope.hasNextPage = true;&#10;  &#125;)&#10;  .error(function(data,status,headers,config)&#123;&#10;      $scope.loadError = true;&#10;      $rootScope.notify(&#34;&#20986;&#38169;&#20102;!!&#35831;&#26816;&#26597;&#32593;&#32476;&#21518;&#37325;&#35797;&#34;);&#10;  &#125;);&#10;  $rootScope.$broadcast(&#39;scroll.refreshComplete&#39;);&#10;&#125;;</span><br></pre></td></tr></table></figure>
<p>注意在显示结束后需要广播<code>scroll.refreshComplete</code>消息，页面中的下拉刷新在接受到该广播后停止下拉刷新的加载动画。该操作用到Posts服务中的refresh函数，如下:<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">refresh: function() &#123;&#10;  console.log(&#34;refresh&#34;);&#10;  var promise = $http.get(SERVER.api + &#39;/posts&#39;,&#123;&#10;    params:&#123;&#10;      page: 1,&#10;      limit : limit&#10;    &#125;&#10;  &#125;);&#10;&#10;  promise.success(function(response)&#123;&#10;    hasNextPage = true;&#10;    nextPage = 2;&#10;    posts = response.data;&#10;  &#125;);&#10;&#10;  return promise;&#10;&#125;,</span><br></pre></td></tr></table></figure></p>
<p>refresh操作会将分页的页数重新置为1，并在请求成功后设置为2.</p>
<h2 id="发布情报">发布情报</h2><p>点击发布情报按钮，会显示发布情报界面，该界面我们使用ionicModal来编写，ionicModal并没有创造一个新的页面状态，而是将页面附在当前页面上面，由用户输入信息，进行操作，完成后隐藏界面，非常方便，该model界面如下:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#60;div class=&#34;modal&#34; &#62;&#10;  &#60;ion-header-bar class=&#34;bar-positive&#34; &#62;&#10;      &#60;h1 class=&#34;title&#34;&#62;&#21457;&#24067;&#24773;&#25253;&#60;/h1&#62;&#10;  &#60;/ion-header-bar&#62;&#10;  &#60;ion-content class=&#34;padding&#34;&#62;&#10;    &#60;ion-list ng-if=&#34;newPost.images.length != 0&#34; class=&#34;card&#34;&#62;&#10;      &#60;div class=&#34;item item-divider item-positive&#34;&#62;&#10;        &#22270;&#29255;&#10;      &#60;/div&#62;&#10;      &#60;div ng-repeat=&#34;image in newPost.images&#34; class=&#34;item item-thumbnail-left item-icon-right&#34;&#62;&#10;        &#60;img ng-src=&#123;&#123;image.url&#125;&#125; ng-click=&#34;showImageModal(image.url)&#34;&#62;&#10;        &#60;h2&#62;&#123;&#123;image.url&#125;&#125;&#60;/h2&#62;&#10;        &#60;i class=&#34;button button-clear icon ion-close-round&#34; ng-click =&#34;removePhoto(image)&#34;&#62;&#60;/i&#62;&#10;      &#60;/div&#62;&#10;    &#60;/ion-list&#62;&#10;    &#60;div class=&#34;card&#34;&#62;&#10;      &#60;div class=&#34;item item-divider item-icon-right item-positive&#34;&#62;&#10;        &#28040;&#24687;&#20869;&#23481;&#10;        &#60;i class=&#34;icon ion-link&#34; ng-click=&#34;showActions()&#34;&#62;&#60;/i&#62;&#10;      &#60;/div&#62;&#10;      &#60;div class=&#34;item item-input&#34;&#62;&#10;        &#60;textarea style=&#34;height:200px;&#34; placeholder=&#34;&#35831;&#36755;&#20837;&#28040;&#24687;&#20869;&#23481;&#34; ng-model=&#34;newPost.content&#34;&#62;&#60;/textarea&#62;&#10;      &#60;/div&#62;&#10;      &#60;div class=&#34;col&#34;&#62;&#10;        &#60;div class=&#34;item item-checkbox&#34;&#62;&#10;          &#60;label class=&#34;checkbox&#34;&#62;&#10;            &#60;input type=&#34;checkbox&#34; ng-model=&#34;newPost.important&#34;&#62;&#10;          &#60;/label&#62;&#10;          &#60;p&#62;&#32039;&#24613;&#19978;&#25253;&#60;/p&#62;&#10;        &#60;/div&#62;&#10;      &#60;/div&#62;&#10;    &#60;/div&#62;&#10;    &#60;button class=&#34;button button-block button-balanced&#34;&#10;    ng-disabled=&#34;newPost.content === &#39;&#39;&#34; ng-click=&#34;createNewPost()&#34;&#62;&#10;      &#21457;&#36865;&#10;    &#60;/button&#62;&#10;    &#60;button class=&#34;button button-block button-assertive&#34; ng-click=&#34;closeNewPostModal()&#34;&#62;&#10;      &#21462;&#28040;&#10;    &#60;/button&#62;&#10;    &#60;/div&#62;&#10;  &#60;/ion-content&#62;&#10;&#60;/div&#62;</span><br></pre></td></tr></table></figure>
<p>包括图片列表，消息内容，以及发送和取消按钮，用于控制该model的代码如下:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">// Create the new  post modal&#10;    $ionicModal.fromTemplateUrl(&#39;templates/post/newModal.html&#39;, &#123;&#10;      animation: &#39;slide-in-up&#39;,&#10;      scope: $scope&#10;    &#125;).then(function(modal) &#123;&#10;      $scope.newPostModal = modal;&#10;    &#125;);&#10;    // show new topic modal&#10;    $scope.showNewPostModal = function() &#123;&#10;      $scope.newPost.content = &#34;&#34;;&#10;      $scope.newPost.important = false;&#10;      $scope.newPost.images = [];&#10;      $scope.newPostModal.show();&#10;    &#125;;&#10;    $scope.closeNewPostModal = function() &#123;&#10;      $scope.newPostModal.hide();&#10;      $scope.newPost.content = &#34;&#34;;&#10;      $scope.newPost.important = false;&#10;      $scope.newPost.images = [];&#10;    &#125;;</span><br></pre></td></tr></table></figure>
<p>该部分代码指定了model显示的方式，其上下文为本页面的上下文，并且设置了显示和隐藏该model的函数。发布情报时要求可以加入图片，加入图片主要由两种途径，一个是打开摄像头进行拍照，另一个是在手机的图片库中进行查找，我们用ionic提供的$ionicActionSheet提供这两个选项，点击添加图片按钮后调用showActions函数,如下:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$scope.showActions = function () &#123;&#10;   // Show the action sheet&#10;      $ionicActionSheet.show(&#123;&#10;       buttons: [&#10;         &#123; text: &#34;&#25293;&#29031;&#34; &#125;,&#10;         &#123; text: &#34;&#22270;&#29255;&#24211;&#34;&#125;&#10;       ],&#10;       titleText: &#34;&#28155;&#21152;&#22270;&#29255;&#34;,&#10;       cancelText: &#39;&#21462;&#28040;&#39;,&#10;       cancel: function() &#123;&#10;       &#125;,&#10;       buttonClicked: function(index) &#123;&#10;         if(index === 0)&#123;&#10;            $scope.takePhoto();&#10;         &#125;else if (index === 1)&#123;&#10;            $scope.pickImage();&#10;         &#125;&#10;         return true;&#10;       &#125;&#10;     &#125;);&#10;  &#125;;</span><br></pre></td></tr></table></figure>
<p>这里我们的图片库操作在某些手机上测试会导致应用崩溃，因此这里略去。如果是拍照服务,我们需要使用cordova的插件org.apache.cordova.camera,该插件允许我们访问设备底层的照相机服务,我们添加Camera服务如下:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">angular.module(&#39;fcws.services&#39;)&#10;.factory(&#39;Camera&#39;, [&#39;$q&#39;, function($q) &#123;&#10;  return &#123;&#10;    getPicture: function(options) &#123;&#10;      var q = $q.defer();&#10;      navigator.camera.getPicture(function(result) &#123;&#10;        // Do any magic you need&#10;        q.resolve(result);&#10;      &#125;, function(err) &#123;&#10;        q.reject(err);&#10;      &#125;, options);&#10;      return q.promise;&#10;    &#125;&#10;  &#125;;&#10;&#125;]);&#10;angular.module(&#39;fcws.services&#39;).config(function($compileProvider)&#123;&#10;  $compileProvider.imgSrcSanitizationWhitelist(/^\s*(https?|ftp|mailto|file|tel):/);&#10;&#125;);</span><br></pre></td></tr></table></figure>
<p>我们使用该服务的getPicture函数就能打开设备的摄像头实现拍照,具体的调用函数为:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">// take photo with camera&#10;$scope.takePhoto = function() &#123;&#10;  if($scope.images.length &#62;=3)&#123;&#10;    alert(&#34;&#26368;&#22810;&#19978;&#20256;&#19977;&#24352;&#22270;&#29255;&#34;);&#10;    return ;&#10;  &#125;&#10;  Camera.getPicture().then(function(imageURI) &#123;&#10;    console.log(imageURI);&#10;    $scope.newPost.images.push(&#123;url:imageURI&#125;);&#10;  &#125;, function(err) &#123;&#10;    console.err(err);&#10;    $rootScope.notify(&#34;&#20986;&#38169;&#20102;&#65292;&#37325;&#35797;&#19968;&#19979;&#34;);&#10;  &#125;);&#10;&#125;;</span><br></pre></td></tr></table></figure>
<p>为了限制上传的带宽流量，我们限制最多上传3脏图片。当然用户可以随时删除自己拍摄的照片:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$scope.removePhoto = function(image) &#123;&#10;    $log.log(&#34;removePhoto&#34;);&#10;    var indexImage = $scope.newPost.images.indexOf(image);&#10;    if (indexImage &#62; -1) &#123;&#10;      $scope.newPost.images.splice(indexImage, 1);&#10;    &#125;&#10;&#125;;</span><br></pre></td></tr></table></figure>
<p>在所有信息填写完毕后，点击发布按钮将触发createNewPost函数,该函数如下:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$scope.createNewPost = function() &#123;&#10;  var content = $scope.newPost.content;&#10;  var important = false;&#10;  if (!content) &#123;&#10;    $rootScope.notify(&#34;&#35831;&#36755;&#20837;&#24773;&#25253;&#20869;&#23481;&#34;);&#10;    return false;&#10;  &#125;&#10;  if (this.newPost.important)&#10;    important = true;&#10;  var date = new Date();&#10;  var createDate = $filter(&#39;date&#39;)(date, &#39;yyyy-MM-dd HH:mm:ss&#39;);&#10;  var form = &#123;&#10;    userName: User.getUserName(),&#10;    userId: User.getUserId(),&#10;    content: content,&#10;    important: important,&#10;    createDate: createDate,&#10;    likes: [],&#10;    replyCount: 0&#10;  &#125;;&#10;  Posts.saveItem(form, User.getToken())&#10;    .success(function(data, status, headers, config) &#123;&#10;      $rootScope.$broadcast(&#39;fetchAll&#39;);&#10;      $scope.newPostModal.hide();&#10;    &#125;)&#10;    .error(function(data, status, headers, config) &#123;&#10;      $rootScope.notify(&#34;&#32593;&#32476;&#36830;&#25509;&#20986;&#38169;&#34;);&#10;    &#125;);&#10;&#125;;</span><br></pre></td></tr></table></figure>
<p>该函数会检查情报信息是否有误，如果无误则将信息打包通过post服务发送给服务器。</p>
<h2 id="详细情报">详细情报</h2><p>详细情报的页面结构见代码文件，如果用户的id和该post的发布者的id是一致的，则在页面上添加删除按钮，只有发布者可以删除自己的情报，详细情报界面可以显示其他用户对该情报的评论，长按某一条评论会显示和该评论相关的操作，如@某人，或如果是该评论的发布者则增加删除该情报的功能.如下:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$scope.showActions = function (reply) &#123;&#10;    var title = &#34;@&#34;+ reply.userName;&#10;    var DeleteButton = (User.getUserId() === reply.userId?&#34;&#21024;&#38500;&#34;:&#34;&#34;);&#10;   // Show the action sheet&#10;     var hideSheet = $ionicActionSheet.show(&#123;&#10;       buttons: [&#10;         &#123; text: &#34;&#22238;&#22797;&#34; &#125;,&#10;       ],&#10;       destructiveText: DeleteButton,&#10;       titleText: title,&#10;       cancelText: &#39;&#21462;&#28040;&#39;,&#10;       cancel: function() &#123;&#10;       &#125;,&#10;      destructiveButtonClicked: function () &#123;&#10;        $log.log(&#34;get here&#34;);&#10;        $scope.showDeleteReplyConfirm(reply);&#10;        return true;&#10;      &#125;,&#10;       buttonClicked: function(index) &#123;&#10;         if(index === 0)&#123;&#10;            $scope.replyData.content = title+&#34; &#34;;&#10;            $timeout(function() &#123;&#10;              document.querySelector(&#39;.reply-new input&#39;).focus();&#10;            &#125;, 1);&#10;         &#125;&#10;         return true;&#10;       &#125;&#10;     &#125;);&#10;  &#125;;</span><br></pre></td></tr></table></figure>
<p>注意到点击按钮后如果是回复按钮则在回复框中添加@某人标记，并将焦点置于该回复框中，这在设备中将触发显示键盘的效果，方便用户进行操作。你也可以为这个情报进行点赞，如果已点过赞，点赞按钮会变成实心，再点会变成空心,我们在post中维护了一个likes列表保存给这个post点赞的用户，如果该用户在这个列表中则该用户已点过赞,具体代码如下:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$scope.isLike = function() &#123;&#10;  var user_id = User.getUserId();&#10;  console.log(user_id);&#10;  var indexUser = $scope.post.likes.indexOf(user_id);&#10;  if (indexUser != -1) &#123;&#10;    return true;&#10;  &#125; else &#123;&#10;    return false;&#10;  &#125;&#10;&#125;;</span><br></pre></td></tr></table></figure>
<p>发表一个评论的过程是发布情报的简化版，这里不再赘述.</p>
<h1 id="指挥控制">指挥控制</h1><p>指挥控制由上级向下级发送命令,包括单点下达和群组下达两个方面。首先我们在app.js中定义指挥控制的状态，以及在templates中定义其页面的结构和显示效果。这些都和之前的登录注册和情报信息类似。这里主要讲解指挥控制的Controller和Service</p>
<h2 id="单点下达">单点下达</h2><p>单点下达主要的部分是需要获得自己的下属部队的长官，这一部分是一个瘦客户端的操作，大部分的处理都在服务器端做完了，我们只需要传入用户所属的部队id，并且判断该用户是否是部队的领导者即可，代码如下:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">var loadLeaders = function () &#123;&#10;      if(User.isLeader())&#123;&#10;        Orgnizations.getTroops(User.getBelong(),User.getToken())&#10;        .success(function (data) &#123;&#10;              $scope.troops = data;&#10;        &#125;)&#10;        .error(function() &#123;&#10;          console.log(&#34;log error&#34;);&#10;        &#125;);&#10;      &#125;else&#123;&#10;        $scope.noData = true;&#10;      &#125;&#10;    &#125;;</span><br></pre></td></tr></table></figure>
<p>如果未非领导人即士兵，士兵没有指导全县，在列表中将不显示任何可以指挥的个人.这里需要向服务器传入自己所属的部队的id，以及用户的token作为标示，获取到列表后，点击某个下属即可对该下属发布命令,发布命令实际上类似于我们发送消息的过程，发送的命令会发到用户的邮箱中去。</p>
<h2 id="群组下达">群组下达</h2><p>群组下达和单点下达一个不同的地方在于显示的列表是你下属的整个部队，你需要对下属整个部队的所有用户发送广播消息。该部分逻辑和单点下达类似，不再赘述</p>
<h2 id="信箱管理">信箱管理</h2><p>上级对下级发送的命令会发送到用户的邮箱中，为了让用户方便的获取信息，我们将信箱的按钮放置在了首页，在用户进入首页时，我们会检查邮箱未读邮件的数量，如果该数量大于0，则将邮箱上防止红点以提醒用户阅读.代码如下:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$scope.getUnReadMessagesCount = function () &#123;&#10;  Message.getMessageCount(User.getUserId(), User.getToken())&#10;  .success(function (data,status,headers,config) &#123;&#10;      $scope.unRead = data.count;&#10;  &#125;).error(function(data, status, headers, config) &#123;&#10;      console.log(&#34;error get unread Messages count&#34;);&#10;      $scope.unRead = 0;&#10;  &#125;);&#10;&#125;</span><br></pre></td></tr></table></figure>
<p>当用户点击进入邮箱时，为了方便起见，我们会同时将邮箱中的所有未读邮件全部置为已读,我们通过Message这个Service完成:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">//mark all messages to read&#10;markAllMessages: function(userid,token) &#123;&#10;  return $http.post(SERVER.api + &#39;/&#39;+ userid+&#39;/messages/mark&#39;,null,&#123;&#10;    method: &#39;POST&#39;,&#10;    params: &#123;&#10;      token: token&#10;    &#125;&#10;  &#125;);&#10;&#125;,</span><br></pre></td></tr></table></figure>
<p>当用户点击具体的某个邮件时，我们会弹出对话框显示该邮件的具体内容,如下:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">// An content show dialog&#10;$scope.showContent = function(message) &#123;&#10; var alertPopup = $ionicPopup.alert(&#123;&#10;   title: message.senderTitle+&#34;-&#34;+message.senderName,&#10;   template: &#34;&#60;br&#62;&#34;+message.content+&#34;&#60;br&#62;&#60;br&#62;&#34;+&#34;&#60;p&#62;&#34;+message.createDate+&#34;&#60;/p&#62;&#34;&#10; &#125;);&#10; alertPopup.then(function(res) &#123;&#10;   if(!message.has_read)&#123;&#10;       Message.readMessage(message._id,User.getToken()).success(function(data, status, headers, config) &#123;&#10;          message = data;&#10;       &#125;).error(function (data, status, headers, config) &#123;&#10;          $rootScope.notify(&#34;&#32593;&#32476;&#36830;&#25509;&#20986;&#38169;&#34;);&#10;       &#125;)&#10;   &#125;&#10; &#125;);&#10;&#125;;</span><br></pre></td></tr></table></figure>
<p>我们使用ionic提供的$ionicPopup服务完成。</p>
<h1 id="军事训练与教育管理与国防动员">军事训练与教育管理与国防动员</h1><p>军事训练，教育管理和国防动员的内容和结构类似，我们以军事训练为例,该功能下由通知计划，训练法规，资料查询，训练考核等4部分构成，他们之间只是内容不同，结构类似，我们以通知计划为例，抽出共性的部分即为显示格式化了的文档信息。在每个子项目对应的控制器文件中都保存了一份关于该条目的文档列表，标示该文档页面的名称以及在服务器对应的url，例如:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$scope.docs = [&#10;  &#123;&#10;    name: &#34;&#35757;&#32451;&#36890;&#30693;&#34;,&#10;    url: &#34;train\/notifications\/train-notice.html&#34;&#10;  &#125;,&#10;  &#123;&#10;    name: &#34;&#19987;&#27494;&#27665;&#20853;&#24178;&#37096;&#38598;&#35757;&#36890;&#30693;&#34;,&#10;    url: &#34;train\/notifications\/assemble-notice.html&#34;&#10;  &#125;&#10;];</span><br></pre></td></tr></table></figure>
<p>用户点击该文档后会调用showDoc函数,该函数调用Docs服务中的showDoc函数,并传入该页面的$scope以及文档数据:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$scope.showDoc = function (doc) &#123;&#10;    Docs.showDoc($scope,doc);&#10;&#125;;</span><br></pre></td></tr></table></figure>
<p>Docs服务中的showDoc函数如下:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">showDoc :function($scope,doc) &#123;&#10;    $rootScope.show(&#34;&#27491;&#22312;&#20174;&#26381;&#21153;&#22120;&#33719;&#21462;&#25968;&#25454;,&#35831;&#31245;&#31561;...&#34;);&#10;    this.getDocData(doc)&#10;    .success(function(data,status, headers, config) &#123;&#10;      $scope.docHtml= $sce.trustAsHtml(data);&#10;      $rootScope.hide();&#10;      PreviewService&#10;        .init(&#39;templates/docModal.html&#39;, $scope)&#10;        .then(function(modal) &#123;&#10;          modal.show();&#10;        &#125;);&#10;    &#125;)&#10;    .error(function(data, status, headers, config) &#123;&#10;      $rootScope.hide();&#10;      $rootScope.notify(&#34;&#20986;&#38169;&#20102;!!&#35831;&#26816;&#26597;&#32593;&#32476;&#21518;&#37325;&#35797;&#34;);&#10;    &#125;);&#10;  &#125;,</span><br></pre></td></tr></table></figure>
<p>首先我们从服务器获取该文档的html数据,这里我们调用了Angular的$sce服务将该数据设置为可以信任的网页文档，这样我们就能显示页面中的图片，默认情况下只能显示最基本的html结构数据，这是Angular的安全机制导致的。获取数据后我们调用PreviewService服务进行显示,该服务为我们为了方便显示文档所创建的服务类,我们首先用init函数获取设置完成后的modal对象:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">var init = function(tpl, $scope) &#123;&#10;  var promise;&#10;  $scope = $scope || $rootScope.$new();&#10;  promise = $ionicModal.fromTemplateUrl(tpl, &#123;&#10;    scope: $scope,&#10;    animation: &#39;slide-in-up&#39;&#10;  &#125;).then(function(modal) &#123;&#10;    $scope.modal = modal;&#10;    return modal;&#10;  &#125;);</span><br></pre></td></tr></table></figure>
<p>然后通过model.show和model.hide进行该文档的显示和隐藏。</p>
<h1 id="设置">设置</h1><p>设置界面主要功能有修改密码，注销登录和退出</p>
<h2 id="修改密码">修改密码</h2><p>修改密码涉及到用户的隐私操作，是重要的安全操作，我们首先要求用户输入原密码以验证用户的身份:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">var validatePassword = function(res) &#123;&#10;      var id = User.getUserId();&#10;      var password = res;&#10;      $rootScope.show(&#39;&#39564;&#35777;&#20013;...&#35831;&#31245;&#20505;&#39;);&#10;      User.confirmPassword(&#123;&#10;        id: id,&#10;        password: password&#10;      &#125;).success(function() &#123;&#10;        $rootScope.hide();&#10;        $window.location.href = (&#39;#/sidemenu/changepw&#39;);&#10;      &#125;).error(function(error) &#123;&#10;        $rootScope.hide();&#10;        $rootScope.notify(&#34;&#23494;&#30721;&#39564;&#35777;&#20986;&#38169;&#34;);&#10;      &#125;);&#10;     &#125;;</span><br></pre></td></tr></table></figure>
<p>如果验证成功则跳转到修改密码页面,输入新密码和重复输入的密码，发送到服务器端即可完成修改密码</p>
<h2 id="注销登录">注销登录</h2><p>注销登录比较简单，我们只需要将保存在本地的用户信息清除，然后跳转到登录页面即可:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$scope.logout = function() &#123;&#10;  User.logoutUser();&#10;  $state.go(&#39;signin&#39;);&#10;&#125;;</span><br></pre></td></tr></table></figure>
<p>相应的logoutUser函数为</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">logoutUser: function () &#123;&#10;  $localstorage.remove(userKey);&#10;  $localstorage.set(isAuthenticatedKey,false);&#10;&#125;,</span><br></pre></td></tr></table></figure>
<p>我们用isAuthenticatedKey来存储我们是否已经登录的标志,这里也显示出编写$localstorage工具类的好处</p>
<h2 id="退出应用">退出应用</h2><p>退出应用只需要调用相应平台的exit()函数即可,如下:<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$scope.shutdown = function() &#123;&#10;  ionic.Platform.exitApp();&#10;&#125;;</span><br></pre></td></tr></table></figure></p>

      
    </div>

    <div class="post-footer">
      
        <div class="post-tags">
          
            <a href="/tags/ionic/"> #ionic </a>
          
            <a href="/tags/mongodb/"> #mongodb </a>
          
            <a href="/tags/nodejs/"> #nodejs </a>
          
        </div>
      

      
        <div class="post-nav">
          <div class="post-nav-prev post-nav-item">
            
              <a href="/2015/11/28/ionic-app-4/">Ionic+Nodejs+Mongod开发端到端混合应用系列教程五 - 服务器端实现</a>
            
          </div>

          <div class="post-nav-next post-nav-item">
            
              <a href="/2015/11/24/ionic-app-2/">Ionic+Nodejs+Mongod开发端到端混合应用系列教程三 - 整体架构</a>
            
          </div>
        </div>
      

      
      
    </div>
  </div>



    <div class="post-spread">
      
        <!-- JiaThis Button BEGIN -->
<div class="jiathis_style">
  <a class="jiathis_button_tsina"></a>
  <a class="jiathis_button_tqq"></a>
  <a class="jiathis_button_weixin"></a>
  <a class="jiathis_button_cqq"></a>
  <a class="jiathis_button_douban"></a>
  <a class="jiathis_button_renren"></a>
  <a class="jiathis_button_qzone"></a>
  <a class="jiathis_button_kaixin001"></a>
  <a class="jiathis_button_copy"></a>
  <a href="http://www.jiathis.com/share" class="jiathis jiathis_txt jiathis_separator jtico jtico_jiathis" target="_blank"></a>
  <a class="jiathis_counter_style"></a>
</div>
<script type="text/javascript" >
  var jiathis_config={
    hideMore:false
  }
</script>
<script type="text/javascript" src="http://v3.jiathis.com/code/jia.js" charset="utf-8"></script>
<!-- JiaThis Button END -->

      
    </div>

    
      <div class="comments" id="comments">
        
          <div id="disqus_thread">
            <noscript>Please enable JavaScript to view the <a href="//disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
          </div>
        
      </div>
    
  </div>


        </div>

        
      </div>


      
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <div id="sidebar" class="sidebar">
    <div class="sidebar-inner">

      
        <ul class="sidebar-nav motion-element">
          <li class="sidebar-nav-toc sidebar-nav-active" data-target="post-toc-wrap">
            文章目录
          </li>
          <li class="sidebar-nav-overview" data-target="site-overview">
            站点概览
          </li>
        </ul>
      

      <div class="site-overview">
        <div class="site-author motion-element">
          <img class="site-author-image" src="https://avatars0.githubusercontent.com/u/4705237?v=3&u=cf53fa292cbafba8a53cfb1feda077c5abced98f&s=140" alt="LinChen" />
          <p class="site-author-name">LinChen</p>
        </div>
        <p class="site-description motion-element">人生不只眼前的苟且，还有音乐和远方。</p>
        <div class="site-state motion-element">
          <div class="site-state-item site-state-posts">
            <a href="/archives">
              <span class="site-state-item-count">52</span>
              <span class="site-state-item-name">日志</span>
            </a>
          </div>

          <div class="site-state-item site-state-categories">
            
              <span class="site-state-item-count">17</span>
              <span class="site-state-item-name">分类</span>
              
          </div>

          <div class="site-state-item site-state-tags">
            <a href="/tags">
              <span class="site-state-item-count">44</span>
              <span class="site-state-item-name">标签</span>
              </a>
          </div>

        </div>

        

        <div class="links-of-author motion-element">
          
            
              <span class="links-of-author-item">
              <a href="https://github.com/rdmclin2" target="_blank">GitHub</a>
            </span>
            
              <span class="links-of-author-item">
              <a href="https://twitter.com/rdmclin2" target="_blank">Twitter</a>
            </span>
            
              <span class="links-of-author-item">
              <a href="http://weibo.com/1842914013/profile?topnav=1&wvr=6" target="_blank">Weibo</a>
            </span>
            
              <span class="links-of-author-item">
              <a href="http://www.douban.com/people/50750460/" target="_blank">DouBan</a>
            </span>
            
              <span class="links-of-author-item">
              <a href="http://www.zhihu.com/people/mengcl" target="_blank">ZhiHu</a>
            </span>
            
          
        </div>

        
        
          <div class="cc-license motion-element">
            <a href="http://creativecommons.org/licenses/by-nc-sa/4.0" class="cc-opacity" target="_blank">
              <img src="/images/cc-by-nc-sa.svg" alt="Creative Commons" />
            </a>
          </div>
        

        <div class="links-of-author motion-element">
          
            <p class="site-author-name"></p>
            
              <span class="links-of-author-item">
              <a href="http://chuan92.com" target="_blank">chuan92</a>
              </span>
            
              <span class="links-of-author-item">
              <a href="https://chepeatio.github.io" target="_blank">chepeatio</a>
              </span>
            
              <span class="links-of-author-item">
              <a href="http://andrewliu.in" target="_blank">andrewliu</a>
              </span>
            
              <span class="links-of-author-item">
              <a href="http://liutianchi.com" target="_blank">liutianchi</a>
              </span>
            
              <span class="links-of-author-item">
              <a href="http://cshuo.xyz/" target="_blank">cshuo</a>
              </span>
            
          
        </div>
        
      </div>

      
        <div class="post-toc-wrap sidebar-panel-active">
          <div class="post-toc-indicator-top post-toc-indicator"></div>
          <div class="post-toc">
            
            
              <div class="post-toc-content"><ol class="nav"><li class="nav-item nav-level-1"><a class="nav-link" href="#工程文件结构"><span class="nav-number">1.</span> <span class="nav-text">工程文件结构</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#创建项目"><span class="nav-number">2.</span> <span class="nav-text">创建项目</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#创建工具类"><span class="nav-number">3.</span> <span class="nav-text">创建工具类</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#入口页面"><span class="nav-number">4.</span> <span class="nav-text">入口页面</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#app-js"><span class="nav-number">5.</span> <span class="nav-text">app.js</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#定义app顶层模块"><span class="nav-number">5.1.</span> <span class="nav-text">定义app顶层模块</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#运行配置"><span class="nav-number">5.2.</span> <span class="nav-text">运行配置</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#路由"><span class="nav-number">5.3.</span> <span class="nav-text">路由</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#服务器常量配置"><span class="nav-number">5.4.</span> <span class="nav-text">服务器常量配置</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#用户登录"><span class="nav-number">6.</span> <span class="nav-text">用户登录</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#情报消息"><span class="nav-number">7.</span> <span class="nav-text">情报消息</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#情报列表"><span class="nav-number">7.1.</span> <span class="nav-text">情报列表</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#分页"><span class="nav-number">7.2.</span> <span class="nav-text">分页</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#下拉刷新"><span class="nav-number">7.3.</span> <span class="nav-text">下拉刷新</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#发布情报"><span class="nav-number">7.4.</span> <span class="nav-text">发布情报</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#详细情报"><span class="nav-number">7.5.</span> <span class="nav-text">详细情报</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#指挥控制"><span class="nav-number">8.</span> <span class="nav-text">指挥控制</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#单点下达"><span class="nav-number">8.1.</span> <span class="nav-text">单点下达</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#群组下达"><span class="nav-number">8.2.</span> <span class="nav-text">群组下达</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#信箱管理"><span class="nav-number">8.3.</span> <span class="nav-text">信箱管理</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#军事训练与教育管理与国防动员"><span class="nav-number">9.</span> <span class="nav-text">军事训练与教育管理与国防动员</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#设置"><span class="nav-number">10.</span> <span class="nav-text">设置</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#修改密码"><span class="nav-number">10.1.</span> <span class="nav-text">修改密码</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#注销登录"><span class="nav-number">10.2.</span> <span class="nav-text">注销登录</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#退出应用"><span class="nav-number">10.3.</span> <span class="nav-text">退出应用</span></a></li></ol></li></ol></div>
            
          </div>
          <div class="post-toc-indicator-bottom post-toc-indicator"></div>
        </div>
      

    </div>
  </div>


    </div>

    <div id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright">
  
  &copy; &nbsp;  2014 - 
  2016
  <span class="with-love">
    <i class="icon-heart"></i>
  </span>
  <span class="author">LinChen</span>
</div>

<div class="powered-by">
  由 <a class="theme-link" href="http://hexo.io">Hexo</a> 强力驱动
</div>

<div class="theme-info">
  主题 -
  <a class="theme-link" href="https://github.com/iissnan/hexo-theme-next">
    NexT.Mist
  </a>
</div>



      </div>
    </div>

    <div class="back-to-top"></div>
  </div>

  <script type="text/javascript" src="/vendors/jquery/index.js?v=2.1.3"></script>

  
  

  
  <script type="text/javascript" src="/vendors/fancybox/source/jquery.fancybox.pack.js"></script>
  <script type="text/javascript" src="/js/fancy-box.js?v=0.4.3"></script>


  <script type="text/javascript" src="/js/helpers.js?v=0.4.3"></script>
  

  <script type="text/javascript" src="/vendors/velocity/velocity.min.js"></script>
  <script type="text/javascript" src="/vendors/velocity/velocity.ui.min.js"></script>

  <script type="text/javascript" src="/js/motion_global.js?v=0.4.3" id="motion.global"></script>



  <script type="text/javascript" src="/js/search-toggle.js"></script>

  
  
<script type="text/javascript" src="/js/bootstrap.scrollspy.js?v=0.4.3" id="bootstrap.scrollspy.custom"></script>


<script type="text/javascript" id="sidebar.toc.highlight">
  $(document).ready(function () {
    var tocSelector = '.post-toc';
    var $tocSelector = $(tocSelector);
    var activeCurrentSelector = '.active-current';

    $tocSelector
      .on('activate.bs.scrollspy', function () {
        var $currentActiveElement = $(tocSelector + ' .active').last();

        removeCurrentActiveClass();
        $currentActiveElement.addClass('active-current');

        $tocSelector[0].scrollTop = $currentActiveElement.position().top;
      })
      .on('clear.bs.scrollspy', function () {
        removeCurrentActiveClass();
      });

    function removeCurrentActiveClass () {
      $(tocSelector + ' ' + activeCurrentSelector)
        .removeClass(activeCurrentSelector.substring(1));
    }

    function processTOC () {
      getTOCMaxHeight();
      toggleTOCOverflowIndicators();
    }

    function getTOCMaxHeight () {
      var $sidebarInner = $('.sidebar-inner');
      var height = $('.sidebar').height() -
                   $tocSelector.position().top -
                   $('.post-toc-indicator-bottom').height();

      $tocSelector.css('height', height);

      return height;
    }

    function toggleTOCOverflowIndicators () {
      tocOverflowIndicator(
        '.post-toc-indicator-top',
        $tocSelector.scrollTop() > 0 ? 'show' : 'hide'
      );

      tocOverflowIndicator(
        '.post-toc-indicator-bottom',
        $tocSelector.scrollTop() >= $tocSelector.find('ol').height() - $tocSelector.height() ? 'hide' : 'show'
      )
    }

    $(document).on('sidebar.didShow', function () {
      processTOC();
    });

    $('body').scrollspy({ target: tocSelector });
    $(window).on('resize', function () {
      if ( $('.sidebar').hasClass('sidebar-active') ) {
        processTOC();
      }
    });

    onScroll($tocSelector);

    function onScroll (element) {
      element.on('mousewheel DOMMouseScroll', function (event) {
          var oe = event.originalEvent;
          var delta = oe.wheelDelta || -oe.detail;
          var self = this;

          this.scrollTop += ( delta < 0 ? 1 : -1 ) * 30;
          event.preventDefault();

          toggleTOCOverflowIndicators();
      });
    }

    function tocOverflowIndicator (indicator, action) {
      $(indicator).velocity('stop').velocity({
        opacity: action === 'show' ? 0.4 : 0
      }, { duration: 100 });
    }

  });
</script>


  <script type="text/javascript" id="sidebar.nav">
    $(document).ready(function () {
      var html = $('html');

      $('.sidebar-nav li').on('click', function () {
        var item = $(this);
        var activeTabClassName = 'sidebar-nav-active';
        var activePanelClassName = 'sidebar-panel-active';
        if (item.hasClass(activeTabClassName)) {
          return;
        }

        var currentTarget = $('.' + activePanelClassName);
        var target = $('.' + item.data('target'));

        currentTarget.velocity('transition.slideUpOut', 200, function () {
          target
            .velocity('stop')
            .velocity('transition.slideDownIn', 200)
            .addClass(activePanelClassName);
        });

        item.siblings().removeClass(activeTabClassName);
        item.addClass(activeTabClassName);
      });

      $('.post-toc a').on('click', function (e) {
        e.preventDefault();
        var offset = $(escapeSelector(this.getAttribute('href'))).offset().top;
        html.velocity('stop').velocity('scroll', {
          offset: offset  + 'px',
          mobileHA: false
        });
      });

      // Expand sidebar on post detail page by default, when post has a toc.
      var $tocContent = $('.post-toc-content');
      if (isDesktop() && CONFIG.sidebar === 'post') {
        if ($tocContent.length > 0 && $tocContent.html().trim().length > 0) {
          displaySidebar();
        }
      }
    });
  </script>




  <script type="text/javascript">
    $(document).ready(function () {
      if (CONFIG.sidebar === 'always') {
        displaySidebar();
      }
    });
  </script>

  

  
  
  

  

    <script type="text/javascript">
      var disqus_shortname = 'mcl';
      var disqus_identifier = '2015/11/28/ionic-app-3/';
      var disqus_title = 'Ionic+Nodejs+Mongod开发端到端混合应用系列教程四 - 客户端实现';
      var disqus_url = 'http://www.mclspace.com/2015/11/28/ionic-app-3/';

      function run_disqus_script(disqus_script){
        var dsq = document.createElement('script');
        dsq.type = 'text/javascript';
        dsq.async = true;
        dsq.src = '//' + disqus_shortname + '.disqus.com/' + disqus_script;
        (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
      }

      run_disqus_script('count.js');
      
        run_disqus_script('embed.js');
      
    </script>
  




  
  

</body>
</html>
