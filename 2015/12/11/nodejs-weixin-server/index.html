<!DOCTYPE html><html lang="zh-CN"><head><meta charset="utf-8"><meta name="X-UA-Compatible" content="IE=edge"><title> Nodejs微信公众平台服务器接入指南 · 坐在键盘上的猫</title><meta name="description" content="Nodejs微信公众平台服务器接入指南 - John Doe"><meta name="viewport" content="width=device-width, initial-scale=1"><link rel="short icon" href="/favicon.ico"><link rel="stylesheet" href="/css/apollo.css"><link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Source+Sans+Pro:400,600" type="text/css"></head><body><header><a href="/" class="logo-link"><img src="/favicon.png"></a><ul class="nav nav-list"><li class="nav-list-item"><a href="/" target="_self" class="nav-list-link">BLOG</a></li><li class="nav-list-item"><a href="/archives/" target="_self" class="nav-list-link">ARCHIVE</a></li><li class="nav-list-item"><a href="http://weibo.com/rdmclin2" target="_blank" class="nav-list-link">WEIBO</a></li><li class="nav-list-item"><a href="https://github.com/rdmclin2" target="_blank" class="nav-list-link">GITHUB</a></li><li class="nav-list-item"><a href="/atom.xml" target="_self" class="nav-list-link">RSS</a></li></ul></header><section class="container"><div class="post"><article class="post-block"><h1 class="post-title">Nodejs微信公众平台服务器接入指南</h1><div class="post-time">2015年12月11日</div><div class="post-content"><blockquote>
<p>最近申请了一个阿里云服务器,尝试着在上面用Nodejs搞个微信公众号机器人玩玩，申请了个人公众账号【技术栈】，你可以加关注然后尝试机器人的效果,虽然它现在还只会回“你来我家接我吧”,而且你看到的时候也不知道这服务器还在不在=。=.</p>
</blockquote>
<a id="more"></a>
<h1 id="搭建环境"><a href="#搭建环境" class="headerlink" title="搭建环境"></a>搭建环境</h1><p>首先在阿里云服务器上搭建Nodejs开发环境，参考<a href="http://mclspace.com/2015/12/09/aliyun-build-nodejs-environment/" target="_blank" rel="external">在阿里云上搭建Nodejs开发环境</a></p>
<h1 id="接入过程"><a href="#接入过程" class="headerlink" title="接入过程"></a>接入过程</h1><p>首先如果你没有<a href="https://mp.weixin.qq.com" target="_blank" rel="external">微信公众平台</a>账号，先去注册一个。</p>
<p>然后进入开发 -&gt; 基本配置,这里会显示你的应用ID和应用密钥,记下这里你的AppID。</p>
<p>在服务器配置一栏中有3个参数:<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">URL是你的服务器的响应微信请求的地址</div><div class="line">Token是你和微信通信的凭证，可以任意设置(3-32字符),例如设置为123456</div><div class="line">EncodingAESKey 用于消息加密的密钥,我们点击后面的随机生成然后记下来就好。</div></pre></td></tr></table></figure></p>
<p>Ok,现在我们有3个参数:AppID,Token和EncodingAESKey，然后我们在本地新建Nodejs服务器。</p>
<p>我们使用Express-generator快捷地生成一个可用的服务器,nodemon用来启动服务器:<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">$ express -e weixin_server</div><div class="line">$ cd weixin_server &amp;&amp; npm install</div><div class="line">$ npm install --save nodemon</div></pre></td></tr></table></figure></p>
<p>在weixin_server中新建文件Makefile和config.js,分别用来自动化构建服务器以及配置服务器:<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">$ touch Makefile config.js</div></pre></td></tr></table></figure></p>
<p>建好的工程的目录如下:<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line">.</div><div class="line">├── app.js</div><div class="line">├── bin</div><div class="line">├── config.js</div><div class="line">├── makefile</div><div class="line">├── node_modules</div><div class="line">├── package.json</div><div class="line">├── public</div><div class="line">├── routes</div><div class="line">└── views</div></pre></td></tr></table></figure></p>
<p>在config.js中写入刚刚我们获得的3个参数:<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">var config = &#123;</div><div class="line">    token: &apos;xxxxxxx&apos;,</div><div class="line">    appid: &apos;xxxxxxxxxxx&apos;,</div><div class="line">    encodingAESKey: &apos;xxxxxxxxxxxxxxxxxxxxxxxx&apos;</div><div class="line">&#125;;</div><div class="line">module.exports = config;</div></pre></td></tr></table></figure></p>
<p>在Makefile中写入运行命令,这里我们设置运行端口为80，目前微信只支持80:<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">run :</div><div class="line">	@PORT=80 ./node_modules/.bin/nodemon ./bin/www</div><div class="line">.PHONY: run</div></pre></td></tr></table></figure></p>
<p>在routes文件夹中新建我们用来处理微信消息的路由wechat.js<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">$ cd routes &amp;&amp; touch wechat.js</div></pre></td></tr></table></figure></p>
<p>在app.js中的routes和users变量下添加我们处理微信消息的路由wechat,并配置使用该路由<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line">var routes = require(&apos;./routes/index&apos;);</div><div class="line">var users = require(&apos;./routes/users&apos;);</div><div class="line">var wechat = require(&apos;./routes/wechat&apos;);</div><div class="line"></div><div class="line">...</div><div class="line"></div><div class="line">app.use(&apos;/&apos;, routes);</div><div class="line">app.use(&apos;/users&apos;, users);</div><div class="line">app.use(&apos;/wechat&apos;,wechat);</div></pre></td></tr></table></figure></p>
<p>下面我们安装wechat模块，这是卜灵大叔写的用于和微信服务器进行通信的Nodejs模块<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">$ npm install --save wechat</div></pre></td></tr></table></figure></p>
<p>然后在我们的wechat.js中填入以下代码:<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div></pre></td><td class="code"><pre><div class="line">var express = require(&apos;express&apos;);</div><div class="line">var router = express.Router();</div><div class="line"></div><div class="line">var wechat = require(&apos;wechat&apos;);</div><div class="line">var config = require(&apos;../config.js&apos;);</div><div class="line"></div><div class="line">router.use(&apos;/&apos;, wechat(config, function (req, res, next) &#123;</div><div class="line">    // 微信输入信息都在req.weixin上</div><div class="line">    var message = req.weixin;</div><div class="line">    if (message.FromUserName === &apos;diaosi&apos;) &#123;</div><div class="line">        // 回复屌丝(普通回复)</div><div class="line">        res.reply(&apos;hehe&apos;);</div><div class="line">    &#125; else if (message.FromUserName === &apos;text&apos;) &#123;</div><div class="line">        //你也可以这样回复text类型的信息</div><div class="line">        res.reply(&#123;</div><div class="line">            content: &apos;text object&apos;,</div><div class="line">            type: &apos;text&apos;</div><div class="line">        &#125;);</div><div class="line">    &#125; else if (message.FromUserName === &apos;hehe&apos;) &#123;</div><div class="line">        // 回复一段音乐</div><div class="line">        res.reply(&#123;</div><div class="line">            type: &quot;music&quot;,</div><div class="line">            content: &#123;</div><div class="line">                title: &quot;来段音乐吧&quot;,</div><div class="line">                description: &quot;一无所有&quot;,</div><div class="line">                musicUrl: &quot;http://mp3.com/xx.mp3&quot;,</div><div class="line">                hqMusicUrl: &quot;http://mp3.com/xx.mp3&quot;,</div><div class="line">                thumbMediaId: &quot;thisThumbMediaId&quot;</div><div class="line">            &#125;</div><div class="line">        &#125;);</div><div class="line">    &#125; else &#123;</div><div class="line">        // 回复高富帅(图文回复)</div><div class="line">        res.reply([</div><div class="line">            &#123;</div><div class="line">                title: &apos;你来我家接我吧&apos;,</div><div class="line">                description: &apos;这是女神与高富帅之间的对话&apos;,</div><div class="line">                picurl: &apos;http://nodeapi.cloudfoundry.com/qrcode.jpg&apos;,</div><div class="line">                url: &apos;http://nodeapi.cloudfoundry.com/&apos;</div><div class="line">            &#125;</div><div class="line">        ]);</div><div class="line">    &#125;</div><div class="line">&#125;));</div><div class="line"></div><div class="line">module.exports = router;</div></pre></td></tr></table></figure></p>
<p>这是wechat模块给的示例代码，我们暂时先用着，下面我们部署服务器,首先将该服务器上传到github或者任何能够从远程部署代码的代码托管服务商上。以github为例新增.gitignore防止将node_modules和.DS_Store上传到服务器:<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">node_modules</div><div class="line">example</div><div class="line">.DS_Store</div><div class="line">coverage</div></pre></td></tr></table></figure></p>
<p>然后在github新建工程上传，不赘述。</p>
<p>在阿里云上clone我们刚刚上传的工程, 然后用make命令运行<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">$ git clone git@github.com:rdmclin2/weixin_server.git</div><div class="line">$ cd wexin_server &amp;&amp; npm install</div><div class="line">$ make run</div></pre></td></tr></table></figure></p>
<p>ok,我们继续到微信公众平台 -&gt; 开发 -&gt; 基本配置,填入<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">URL : &lt;your ip&gt;/wechat</div><div class="line">Token : &lt;your token&gt;</div><div class="line">EncodingAESKey: &lt;your EncodingAESKey&gt;</div><div class="line">消息加解密方式 : 安全模式</div></pre></td></tr></table></figure></p>
<p>点击提交,完成接入。</p>
<h1 id="github"><a href="#github" class="headerlink" title="github"></a>github</h1><p>本篇示例代码已经上传到github<a href="https://github.com/rdmclin2/weixin_server" target="_blank" rel="external">weixin_server</a>，欢迎各种拍砖提issue。</p>
<h1 id="本地调试"><a href="#本地调试" class="headerlink" title="本地调试"></a>本地调试</h1><p>微信消息不能发到内网ip上，这给本地调试带来了很多困难，要在本地接受微信服务器的消息需要用拥有公网IP的主机转发来实现内网穿透。现在很多方案总的来说就是使用ngrok，不过这玩意不幸被墙，不过它是开源的，提供了1.0的源码。</p>
<p>一种方案就是自己在vps配置上配置ngrok,适合喜欢折腾的人,可以参考<a href="https://imququ.com/post/self-hosted-ngrokd.html" target="_blank" rel="external">搭建 ngrok 服务实现内网穿透</a></p>
<p>另一种方案就是别人在自己的vps上已经配置好了，用的时候它给你分配一个子域名给你使用。国内有<a href="http://natapp.cn" target="_blank" rel="external">natapp</a>,更接腾讯地气的是用QQ浏览器的微信本地调试插件详见<a href="http://blog.qqbrowser.cc/wei-xin-gong-zhong-hao-ben-di-diao-shi/" target="_blank" rel="external">http://blog.qqbrowser.cc/wei-xin-gong-zhong-hao-ben-di-diao-shi/</a></p>
</div></article></div></section><footer><div class="paginator"><a href="/2015/12/28/llfc-by-chenbi/" class="prev">PRVE</a><a href="/2015/12/09/nodejs-aliyun-build-environment/" class="next">NEXT</a></div><div id="disqus_thread"></div><script>var disqus_shortname = 'mcl';
var disqus_identifier = '2015/12/11/nodejs-weixin-server/';
var disqus_title = 'Nodejs微信公众平台服务器接入指南';
var disqus_url = 'http://www.mclspace.com/2015/12/11/nodejs-weixin-server/';
(function() {
    var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
    dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
    (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
})();</script><script id="dsq-count-scr" src="//mcl.disqus.com/count.js" async></script><div class="copyright"><p>© 2015 - 2017 <a href="http://www.mclspace.com">John Doe</a>, unless otherwise noted.</p></div></footer><script>var _hmt = _hmt || [];(function() {var hm = document.createElement("script");hm.src = "//hm.baidu.com/hm.js?6b26d13232555e4d64b5a8c3567ccda9";var s = document.getElementsByTagName("script")[0]; s.parentNode.insertBefore(hm, s);})();</script><script src="https://cdn.bootcss.com/mathjax/2.5.3/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script></body></html>